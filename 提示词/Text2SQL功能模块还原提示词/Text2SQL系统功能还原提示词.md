# Text2SQL系统功能还原提示词

## 系统概述

Text2SQL系统是一个智能的自然语言到SQL查询转换平台，支持用户通过自然语言描述查询需求，自动生成对应的SQL语句并执行查询。系统采用多智能体协作架构，结合向量检索、知识库管理和流式响应等技术，提供高效准确的数据查询服务。

### 技术架构特点
- **多智能体协作**：基于AutoGen AgentChat框架的智能体编排
- **流式响应**：WebSocket实时通信，支持流式数据传输
- **向量检索**：ChromaDB + Milvus双引擎混合检索
- **多数据库支持**：MySQL、PostgreSQL、SQLite、Oracle、SQL Server
- **知识库管理**：支持文档上传、向量化存储和智能检索

## 核心功能模块

### 1. 智能查询分析服务

#### 功能描述
负责分析用户的自然语言查询，提取关键实体、关系和查询意图，为后续SQL生成提供结构化信息。

#### 核心组件
- **QueryAnalyzerAgent**: 查询分析智能体
- **查询意图识别**: 识别聚合操作、时间过滤、比较操作等
- **实体提取**: 从自然语言中提取数据库相关实体
- **关系推理**: 分析实体间的关联关系

#### 功能还原提示词
```
你需要实现一个智能查询分析服务，具备以下能力：

1. **自然语言理解**
   - 解析用户的自然语言查询
   - 识别查询中的关键实体和概念
   - 理解查询的业务意图和逻辑关系

2. **查询意图分析**
   - 识别查询类型（统计、筛选、排序、聚合等）
   - 提取时间相关的查询条件
   - 识别比较操作和数值范围
   - 分析聚合需求（COUNT、SUM、AVG等）

3. **实体关系映射**
   - 将自然语言实体映射到数据库表和字段
   - 推理表间关联关系
   - 处理同义词和别名映射

4. **结构化输出**
   - 生成标准化的查询分析结果
   - 包含实体列表、关系描述、查询意图等
   - 为SQL生成提供结构化输入

技术要求：
- 使用大语言模型进行自然语言理解
- 支持中英文查询分析
- 提供缓存机制避免重复分析
- 具备回退机制处理分析失败情况
```

### 2. 数据库模式检索服务

#### 功能描述
基于查询分析结果，从数据库元数据中检索相关的表结构、字段信息和关系约束，为SQL生成提供准确的模式上下文。

#### 核心组件
- **模式检索引擎**: 基于语义相似度的表结构检索
- **关系图谱**: Neo4j存储的数据库关系图谱
- **向量检索**: Milvus向量数据库加速检索
- **值映射服务**: 处理自然语言值与数据库值的映射

#### 功能还原提示词
```
你需要实现一个数据库模式检索服务，具备以下能力：

1. **元数据管理**
   - 存储和管理数据库表结构信息
   - 维护字段类型、约束和索引信息
   - 管理表间关系和外键约束

2. **语义检索**
   - 基于查询分析结果检索相关表结构
   - 使用向量相似度匹配相关字段
   - 支持模糊匹配和同义词检索

3. **关系推理**
   - 基于外键关系推理表间连接
   - 识别多表查询的最优连接路径
   - 处理复杂的多层关系查询

4. **值映射处理**
   - 维护自然语言值与数据库值的映射关系
   - 处理枚举值、编码值的转换
   - 支持模糊匹配和LIKE操作建议

5. **上下文构建**
   - 生成SQL生成所需的完整模式上下文
   - 包含表结构、关系信息、示例数据
   - 优化上下文大小，避免token超限

技术要求：
- 集成Neo4j图数据库存储关系
- 使用Milvus向量数据库加速检索
- 支持多种数据库类型（MySQL、PostgreSQL等）
- 提供缓存机制提升检索性能
```

### 3. SQL生成与优化服务

#### 功能描述
基于查询分析和模式检索结果，使用大语言模型生成准确的SQL查询语句，并进行语法验证和优化。

#### 核心组件
- **SqlGeneratorAgent**: SQL生成智能体
- **SQL验证器**: 语法和逻辑验证
- **查询优化器**: SQL性能优化建议
- **多数据库适配**: 支持不同数据库方言

#### 功能还原提示词
```
你需要实现一个SQL生成与优化服务，具备以下能力：

1. **智能SQL生成**
   - 基于自然语言查询和数据库模式生成SQL
   - 处理复杂的多表连接查询
   - 支持聚合函数、子查询、窗口函数
   - 生成符合数据库方言的标准SQL

2. **查询逻辑构建**
   - 正确处理WHERE条件和过滤逻辑
   - 实现适当的GROUP BY和ORDER BY
   - 处理HAVING子句和复杂条件
   - 支持LIMIT和分页查询

3. **SQL验证与优化**
   - 验证SQL语法正确性
   - 检查表名和字段名有效性
   - 提供查询性能优化建议
   - 避免潜在的性能问题

4. **多数据库支持**
   - 适配MySQL、PostgreSQL、SQLite等
   - 处理不同数据库的语法差异
   - 支持数据库特定的函数和特性

5. **错误处理**
   - 提供详细的错误信息和修复建议
   - 支持SQL调试和问题诊断
   - 实现优雅的降级处理

技术要求：
- 使用大语言模型进行SQL生成
- 集成sqlparse进行SQL解析和验证
- 支持温度控制确保生成稳定性
- 提供详细的生成过程日志
```

### 4. SQL执行与结果处理服务

#### 功能描述
安全执行生成的SQL查询，处理查询结果，并提供数据格式化和可视化建议。

#### 核心组件
- **SqlExecutorAgent**: SQL执行智能体
- **数据库连接池**: 多数据库连接管理
- **结果处理器**: 数据格式化和转换
- **安全控制**: SQL注入防护和权限控制

#### 功能还原提示词
```
你需要实现一个SQL执行与结果处理服务，具备以下能力：

1. **安全执行**
   - 实现SQL注入防护机制
   - 限制危险操作（DELETE、DROP等）
   - 支持查询超时和资源限制
   - 提供执行权限控制

2. **多数据库连接**
   - 管理多种数据库的连接池
   - 支持连接复用和自动重连
   - 处理连接异常和故障转移
   - 提供连接状态监控

3. **结果处理**
   - 将查询结果转换为标准格式
   - 处理大结果集的分页和截断
   - 支持多种数据类型的序列化
   - 提供结果缓存机制

4. **错误处理**
   - 捕获和分类数据库执行错误
   - 提供用户友好的错误信息
   - 支持错误恢复和重试机制
   - 记录详细的执行日志

5. **性能监控**
   - 监控查询执行时间和资源消耗
   - 提供慢查询检测和优化建议
   - 支持查询计划分析

技术要求：
- 使用pandas处理查询结果
- 支持异步执行和并发控制
- 集成多种数据库驱动
- 提供详细的执行统计信息
```

### 5. SQL解释与文档生成服务

#### 功能描述
为生成的SQL查询提供详细的解释说明，帮助用户理解查询逻辑和结果含义。

#### 核心组件
- **SqlExplainerAgent**: SQL解释智能体
- **查询分解器**: SQL语句结构分析
- **业务逻辑解释**: 将技术实现转换为业务描述
- **文档生成器**: 生成结构化的查询文档

#### 功能还原提示词
```
你需要实现一个SQL解释与文档生成服务，具备以下能力：

1. **SQL结构分析**
   - 解析SQL语句的各个组成部分
   - 识别表连接、过滤条件、聚合操作
   - 分析查询的执行逻辑和数据流

2. **业务逻辑解释**
   - 将技术SQL转换为业务语言描述
   - 解释查询的业务目的和意义
   - 说明结果数据的含义和用途

3. **查询步骤分解**
   - 按逻辑顺序分解查询执行步骤
   - 解释每个步骤的作用和结果
   - 提供清晰的执行流程说明

4. **性能分析**
   - 分析查询的性能特征
   - 识别潜在的性能瓶颈
   - 提供优化建议和替代方案

5. **文档生成**
   - 生成结构化的查询文档
   - 包含查询目的、逻辑、结果说明
   - 支持多种输出格式（Markdown、HTML等）

技术要求：
- 使用大语言模型进行智能解释
- 集成SQL解析器分析查询结构
- 支持中英文解释输出
- 提供模板化的文档格式
```

### 6. 可视化推荐服务

#### 功能描述
基于查询结果的数据特征，智能推荐最适合的数据可视化方式和配置参数。

#### 核心组件
- **VisualizationRecommenderAgent**: 可视化推荐智能体
- **数据分析器**: 分析结果数据的统计特征
- **图表匹配器**: 匹配最适合的图表类型
- **配置生成器**: 生成可视化配置参数

#### 功能还原提示词
```
你需要实现一个可视化推荐服务，具备以下能力：

1. **数据特征分析**
   - 分析查询结果的数据类型和分布
   - 识别数值型、分类型、时间型数据
   - 计算数据的统计特征和趋势

2. **图表类型推荐**
   - 基于数据特征推荐最适合的图表类型
   - 支持柱状图、折线图、饼图、散点图等
   - 考虑数据维度和业务场景

3. **可视化配置**
   - 生成图表的详细配置参数
   - 包含坐标轴、颜色、标签等设置
   - 支持响应式和交互式配置

4. **多场景适配**
   - 适配不同的业务分析场景
   - 支持趋势分析、对比分析、分布分析
   - 提供多种可视化方案选择

5. **配置输出**
   - 生成标准化的可视化配置JSON
   - 兼容主流图表库（ECharts、D3等）
   - 提供配置说明和使用指南

技术要求：
- 使用统计分析算法分析数据特征
- 集成机器学习模型进行智能推荐
- 支持多种图表库的配置格式
- 提供可视化效果预览
```

### 7. 知识库管理系统

#### 功能描述
管理Text2SQL相关的知识库，包括数据库文档、查询示例、最佳实践等，支持向量化存储和智能检索。

#### 核心组件
- **KnowledgeBaseController**: 知识库控制器
- **文档处理器**: 支持多种文档格式的解析
- **向量化服务**: ChromaDB向量存储
- **检索服务**: 基于语义相似度的知识检索

#### 功能还原提示词
```
你需要实现一个知识库管理系统，具备以下能力：

1. **知识库管理**
   - 创建和管理多个知识库实例
   - 支持公共和私有知识库
   - 提供知识库的权限控制和访问管理

2. **文档处理**
   - 支持多种文档格式（PDF、Word、Markdown等）
   - 实现文档内容的智能解析和提取
   - 支持文档的分块和向量化处理

3. **向量存储**
   - 使用ChromaDB存储文档向量
   - 支持多种嵌入模型（BGE、OpenAI等）
   - 提供向量索引和相似度检索

4. **智能检索**
   - 基于语义相似度检索相关知识
   - 支持混合检索（向量+关键词）
   - 提供检索结果的排序和过滤

5. **知识应用**
   - 将检索到的知识融入SQL生成过程
   - 提供查询示例和最佳实践参考
   - 支持知识的动态更新和维护

技术要求：
- 集成ChromaDB向量数据库
- 使用Sentence-Transformers进行文本嵌入
- 支持MinIO对象存储
- 提供RESTful API接口
```

### 8. 流式响应与通信服务

#### 功能描述
提供基于WebSocket的实时通信能力，支持流式数据传输和用户交互反馈。

#### 核心组件
- **WebSocket服务器**: 实时通信服务
- **StreamResponseCollector**: 流式响应收集器
- **消息路由器**: 智能体间消息路由
- **用户交互处理**: 处理用户反馈和输入

#### 功能还原提示词
```
你需要实现一个流式响应与通信服务，具备以下能力：

1. **WebSocket通信**
   - 建立稳定的WebSocket连接
   - 支持双向实时数据传输
   - 处理连接异常和自动重连

2. **流式响应**
   - 实时推送处理进度和中间结果
   - 支持多种消息类型的流式传输
   - 提供响应的分区和标记

3. **消息路由**
   - 实现智能体间的消息路由
   - 支持消息的过滤和转换
   - 提供消息的优先级和排序

4. **用户交互**
   - 支持用户实时反馈和输入
   - 处理用户的确认、修正、取消操作
   - 提供交互式的查询优化

5. **会话管理**
   - 管理用户会话和状态
   - 支持会话的暂停、恢复、超时
   - 提供会话历史和上下文保持

技术要求：
- 使用FastAPI WebSocket支持
- 集成asyncio异步处理
- 提供消息队列和缓冲机制
- 支持负载均衡和水平扩展
```

## 前端界面系统

### 9. 智能查询界面

#### 功能描述
提供用户友好的查询输入界面，支持自然语言输入、查询历史、示例查询等功能。

#### 功能还原提示词
```
你需要实现一个智能查询界面，具备以下能力：

1. **查询输入**
   - 提供智能的查询输入框
   - 支持自动补全和语法提示
   - 提供查询模板和示例

2. **数据库选择**
   - 显示可用的数据库连接
   - 支持连接状态检查和切换
   - 提供连接配置和测试

3. **查询历史**
   - 记录和显示查询历史
   - 支持历史查询的重用和编辑
   - 提供查询收藏和分类

4. **实时反馈**
   - 显示查询处理的实时进度
   - 支持用户交互和反馈
   - 提供错误提示和修复建议

技术要求：
- 使用React/Vue构建响应式界面
- 集成WebSocket实现实时通信
- 提供优雅的加载和错误状态
- 支持移动端适配
```

### 10. 结果展示与可视化界面

#### 功能描述
展示查询结果、SQL语句、执行统计和可视化图表，提供多种数据展示方式。

#### 功能还原提示词
```
你需要实现一个结果展示与可视化界面，具备以下能力：

1. **多标签展示**
   - 分标签显示分析、SQL、结果、可视化
   - 支持标签间的快速切换
   - 提供标签状态和进度指示

2. **SQL展示**
   - 语法高亮显示生成的SQL
   - 支持SQL的复制和编辑
   - 提供SQL解释和文档

3. **数据表格**
   - 以表格形式展示查询结果
   - 支持排序、过滤、分页
   - 提供数据导出功能

4. **可视化图表**
   - 根据推荐配置渲染图表
   - 支持多种图表类型切换
   - 提供交互式图表操作

5. **执行统计**
   - 显示查询执行时间和性能指标
   - 提供错误信息和调试信息
   - 支持执行日志的查看

技术要求：
- 使用现代前端框架（React/Vue）
- 集成图表库（ECharts/D3）
- 支持响应式设计
- 提供良好的用户体验
```

## 系统架构设计

### 整体架构还原提示词
```
你需要设计一个完整的Text2SQL系统架构，具备以下特征：

1. **微服务架构**
   - 将功能模块拆分为独立的微服务
   - 每个服务负责特定的业务功能
   - 支持服务的独立部署和扩展

2. **智能体编排**
   - 使用AutoGen AgentChat框架
   - 实现多智能体的协作和通信
   - 支持智能体的动态注册和发现

3. **数据存储层**
   - 关系数据库存储结构化数据
   - 向量数据库存储嵌入向量
   - 图数据库存储关系信息
   - 对象存储管理文件资源

4. **API网关**
   - 统一的API入口和路由
   - 支持认证、授权、限流
   - 提供API文档和监控

5. **消息队列**
   - 异步任务处理和消息传递
   - 支持任务的可靠性和重试
   - 提供消息的持久化和监控

6. **监控告警**
   - 系统性能和健康状态监控
   - 异常检测和自动告警
   - 日志收集和分析

技术栈：
- 后端：Python + FastAPI + AutoGen
- 前端：React/Vue + TypeScript
- 数据库：MySQL + ChromaDB + Neo4j + MinIO
- 消息队列：Redis/RabbitMQ
- 监控：Prometheus + Grafana
- 部署：Docker + Kubernetes
```

## 部署与运维

### 部署配置还原提示词
```
你需要设计Text2SQL系统的部署方案，包括：

1. **容器化部署**
   - 为每个服务创建Docker镜像
   - 编写docker-compose配置文件
   - 支持开发、测试、生产环境

2. **环境配置**
   - 数据库连接配置
   - API密钥和认证配置
   - 服务发现和注册配置

3. **扩展性设计**
   - 支持水平扩展和负载均衡
   - 提供自动扩缩容机制
   - 优化资源使用和成本

4. **监控运维**
   - 健康检查和服务监控
   - 日志收集和分析
   - 性能优化和调优

5. **安全配置**
   - 网络安全和访问控制
   - 数据加密和隐私保护
   - 安全审计和合规检查
```

## 扩展建议

1. **多语言支持**: 扩展对更多自然语言的支持
2. **高级分析**: 集成更多统计分析和机器学习功能
3. **协作功能**: 支持团队协作和查询分享
4. **API集成**: 提供丰富的API接口供第三方集成
5. **移动应用**: 开发移动端应用支持
6. **企业集成**: 与企业BI工具和数据平台集成

---

*本文档基于对现有Text2SQL系统的深度分析生成，涵盖了系统的核心功能模块、技术架构和实现细节，可作为系统重构或新建的完整指南。*