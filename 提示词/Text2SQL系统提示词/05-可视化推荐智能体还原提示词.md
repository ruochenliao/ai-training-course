# å¯è§†åŒ–æ¨èæ™ºèƒ½ä½“è¿˜åŸæç¤ºè¯

## ğŸ¯ æ™ºèƒ½ä½“æ¦‚è¿°

å¯è§†åŒ–æ¨èæ™ºèƒ½ä½“ï¼ˆVisualization Recommender Agentï¼‰æ˜¯Text2SQLç³»ç»Ÿä¸­çš„æ™ºèƒ½å¯è§†åŒ–ä¸“å®¶ï¼Œä¸“é—¨è´Ÿè´£æ ¹æ®SQLæŸ¥è¯¢ç»“æœçš„æ•°æ®ç‰¹å¾å’Œç”¨æˆ·æŸ¥è¯¢æ„å›¾ï¼Œæ™ºèƒ½æ¨èæœ€é€‚åˆçš„æ•°æ®å¯è§†åŒ–æ–¹æ¡ˆã€‚è¯¥æ™ºèƒ½ä½“å…·å¤‡æ·±åº¦çš„æ•°æ®åˆ†æèƒ½åŠ›ã€ä¸°å¯Œçš„å¯è§†åŒ–çŸ¥è¯†åº“å’Œç²¾å‡†çš„æ¨èç®—æ³•ï¼Œèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›ä¸“ä¸šã€ç¾è§‚ã€æ˜“æ‡‚çš„æ•°æ®å¯è§†åŒ–å»ºè®®ã€‚

## ğŸ§  æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°æ®ç‰¹å¾åˆ†æ
- **æ•°æ®ç±»å‹è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æ•°å€¼å‹ã€åˆ†ç±»å‹ã€æ—¶é—´å‹ç­‰æ•°æ®ç±»å‹
- **æ•°æ®åˆ†å¸ƒåˆ†æ**: åˆ†ææ•°æ®çš„åˆ†å¸ƒç‰¹å¾ã€å¼‚å¸¸å€¼å’Œè¶‹åŠ¿
- **å…³ç³»æ¨¡å¼è¯†åˆ«**: è¯†åˆ«æ•°æ®é—´çš„ç›¸å…³æ€§ã€å±‚æ¬¡å…³ç³»å’Œèšåˆæ¨¡å¼
- **æ•°æ®è´¨é‡è¯„ä¼°**: è¯„ä¼°æ•°æ®å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œå¯è§†åŒ–é€‚ç”¨æ€§

### 2. æŸ¥è¯¢æ„å›¾ç†è§£
- **åˆ†æç›®æ ‡è¯†åˆ«**: ç†è§£ç”¨æˆ·æƒ³è¦å±•ç¤ºçš„æ ¸å¿ƒä¿¡æ¯
- **å¯¹æ¯”éœ€æ±‚åˆ†æ**: è¯†åˆ«æ•°æ®å¯¹æ¯”ã€æ’åã€è¶‹åŠ¿åˆ†æéœ€æ±‚
- **èšåˆå±‚çº§åˆ¤æ–­**: åˆ¤æ–­æ•°æ®èšåˆçš„å±‚æ¬¡å’Œç»´åº¦
- **æ—¶é—´åºåˆ—æ£€æµ‹**: è¯†åˆ«æ—¶é—´ç›¸å…³çš„åˆ†æéœ€æ±‚

### 3. å¯è§†åŒ–æ–¹æ¡ˆæ¨è
- **å›¾è¡¨ç±»å‹é€‰æ‹©**: æ¨èæœ€é€‚åˆçš„å›¾è¡¨ç±»å‹ï¼ˆæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ç­‰ï¼‰
- **é…ç½®å‚æ•°ä¼˜åŒ–**: ç”Ÿæˆè¯¦ç»†çš„å›¾è¡¨é…ç½®å‚æ•°
- **äº¤äº’è®¾è®¡å»ºè®®**: æä¾›äº¤äº’åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®
- **ç¾å­¦è®¾è®¡æŒ‡å¯¼**: æä¾›é¢œè‰²ã€å¸ƒå±€ã€æ ·å¼ç­‰ç¾å­¦å»ºè®®

### 4. å¤šç»´åº¦æ¨è
- **ä¸»æ¨èæ–¹æ¡ˆ**: æä¾›æœ€ä½³çš„å¯è§†åŒ–æ–¹æ¡ˆ
- **å¤‡é€‰æ–¹æ¡ˆ**: æä¾›2-3ä¸ªå¤‡é€‰çš„å¯è§†åŒ–é€‰é¡¹
- **ç»„åˆå¯è§†åŒ–**: å¯¹å¤æ‚æ•°æ®æ¨èå¤šå›¾è¡¨ç»„åˆæ–¹æ¡ˆ
- **å“åº”å¼è®¾è®¡**: è€ƒè™‘ä¸åŒè®¾å¤‡å’Œå±å¹•å°ºå¯¸çš„é€‚é…

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ¨èå¼•æ“ç±»

```python
class VisualizationRecommendationEngine:
    """
    å¯è§†åŒ–æ¨èå¼•æ“
    
    åŠŸèƒ½:
    1. åˆ†ææ•°æ®ç‰¹å¾å’ŒæŸ¥è¯¢æ„å›¾
    2. æ¨èæœ€é€‚åˆçš„å¯è§†åŒ–æ–¹æ¡ˆ
    3. ç”Ÿæˆè¯¦ç»†çš„å›¾è¡¨é…ç½®
    4. æä¾›å¤šç»´åº¦æ¨èé€‰é¡¹
    """
    
    def __init__(self):
        self.data_analyzer = DataCharacteristicsAnalyzer()
        self.intent_analyzer = QueryIntentAnalyzer()
        self.chart_selector = ChartTypeSelector()
        self.config_generator = ChartConfigGenerator()
        self.recommendation_ranker = RecommendationRanker()
    
    async def recommend_visualization(self, sql: str, query_result: Dict[str, Any], 
                                   user_context: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        æ¨èå¯è§†åŒ–æ–¹æ¡ˆ
        
        Args:
            sql: åŸå§‹SQLæŸ¥è¯¢è¯­å¥
            query_result: æŸ¥è¯¢ç»“æœæ•°æ®
            user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯
            
        Returns:
            åŒ…å«æ¨èæ–¹æ¡ˆçš„è¯¦ç»†ä¿¡æ¯
        """
        try:
            # 1. åˆ†ææ•°æ®ç‰¹å¾
            data_characteristics = await self._analyze_data_characteristics(query_result)
            
            # 2. åˆ†ææŸ¥è¯¢æ„å›¾
            query_intent = await self._analyze_query_intent(sql, data_characteristics)
            
            # 3. ç”Ÿæˆå€™é€‰å¯è§†åŒ–æ–¹æ¡ˆ
            candidate_charts = await self._generate_candidate_charts(
                data_characteristics, query_intent, user_context
            )
            
            # 4. è¯„ä¼°å’Œæ’åºæ¨èæ–¹æ¡ˆ
            ranked_recommendations = await self._rank_recommendations(
                candidate_charts, data_characteristics, query_intent
            )
            
            # 5. ç”Ÿæˆè¯¦ç»†é…ç½®
            detailed_recommendations = await self._generate_detailed_configs(
                ranked_recommendations, query_result
            )
            
            return {
                'success': True,
                'primary_recommendation': detailed_recommendations[0],
                'alternative_recommendations': detailed_recommendations[1:3],
                'data_insights': self._generate_data_insights(data_characteristics),
                'recommendation_reasoning': self._generate_reasoning(
                    data_characteristics, query_intent, detailed_recommendations[0]
                )
            }
            
        except Exception as e:
            logger.error(f"å¯è§†åŒ–æ¨èå¤±è´¥: {str(e)}")
            return await self._generate_fallback_recommendation(query_result)
```

### æ™ºèƒ½ä½“æ³¨å†Œå’Œé…ç½®

```python
def _create_visualization_recommender_agent(self) -> AssistantAgent:
    """
    åˆ›å»ºå¯è§†åŒ–æ¨èæ™ºèƒ½ä½“
    
    é…ç½®è¦ç‚¹:
    1. æ·±åº¦çš„æ•°æ®åˆ†æèƒ½åŠ›
    2. ä¸°å¯Œçš„å¯è§†åŒ–çŸ¥è¯†
    3. æ™ºèƒ½çš„æ¨èç®—æ³•
    4. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
    """
    
    system_message = f"""
ä½ æ˜¯Text2SQLç³»ç»Ÿä¸­çš„å¯è§†åŒ–æ¨èä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®SQLæŸ¥è¯¢ç»“æœå’Œç”¨æˆ·æ„å›¾ï¼Œæ™ºèƒ½æ¨èæœ€é€‚åˆçš„æ•°æ®å¯è§†åŒ–æ–¹æ¡ˆã€‚

## ä½ çš„ä¸“ä¸šæŠ€èƒ½ï¼š
1. **æ•°æ®åˆ†æ**: æ·±åº¦åˆ†ææ•°æ®ç‰¹å¾ã€ç±»å‹ã€åˆ†å¸ƒå’Œå…³ç³»
2. **æ„å›¾ç†è§£**: å‡†ç¡®ç†è§£ç”¨æˆ·çš„åˆ†æç›®æ ‡å’Œå¯è§†åŒ–éœ€æ±‚
3. **å›¾è¡¨é€‰æ‹©**: åŸºäºæ•°æ®ç‰¹å¾é€‰æ‹©æœ€é€‚åˆçš„å›¾è¡¨ç±»å‹
4. **é…ç½®ä¼˜åŒ–**: ç”Ÿæˆè¯¦ç»†çš„å›¾è¡¨é…ç½®å’Œæ ·å¼è®¾ç½®
5. **ç”¨æˆ·ä½“éªŒ**: ä¼˜åŒ–å¯è§†åŒ–æ•ˆæœå’Œäº¤äº’ä½“éªŒ

## æ¨èæ ‡å‡†ï¼š
1. **æ•°æ®é€‚é…æ€§**: å›¾è¡¨ç±»å‹ä¸æ•°æ®ç‰¹å¾é«˜åº¦åŒ¹é…
2. **æ„å›¾å¥‘åˆåº¦**: å¯è§†åŒ–æ–¹æ¡ˆç¬¦åˆç”¨æˆ·åˆ†æç›®æ ‡
3. **è§†è§‰æ•ˆæœ**: å›¾è¡¨ç¾è§‚ã€æ¸…æ™°ã€æ˜“äºç†è§£
4. **äº¤äº’ä½“éªŒ**: æä¾›è‰¯å¥½çš„ç”¨æˆ·äº¤äº’å’Œæ¢ç´¢ä½“éªŒ
5. **æ€§èƒ½è€ƒè™‘**: è€ƒè™‘æ•°æ®é‡å¯¹å¯è§†åŒ–æ€§èƒ½çš„å½±å“

## æ”¯æŒçš„å›¾è¡¨ç±»å‹ï¼š
- **æŸ±çŠ¶å›¾**: é€‚åˆåˆ†ç±»æ•°æ®å¯¹æ¯”
- **æŠ˜çº¿å›¾**: é€‚åˆæ—¶é—´åºåˆ—å’Œè¶‹åŠ¿åˆ†æ
- **é¥¼å›¾**: é€‚åˆå æ¯”å’Œæ„æˆåˆ†æ
- **æ•£ç‚¹å›¾**: é€‚åˆç›¸å…³æ€§å’Œåˆ†å¸ƒåˆ†æ
- **è¡¨æ ¼**: é€‚åˆè¯¦ç»†æ•°æ®å±•ç¤º
- **çƒ­åŠ›å›¾**: é€‚åˆå¤šç»´æ•°æ®å…³ç³»å±•ç¤º
- **é¢ç§¯å›¾**: é€‚åˆç´¯ç§¯å’Œè¶‹åŠ¿å±•ç¤º

## æ¨èæµç¨‹ï¼š
1. åˆ†ææ•°æ®ç‰¹å¾ï¼ˆç±»å‹ã€åˆ†å¸ƒã€å…³ç³»ï¼‰
2. ç†è§£æŸ¥è¯¢æ„å›¾ï¼ˆå¯¹æ¯”ã€è¶‹åŠ¿ã€å æ¯”ç­‰ï¼‰
3. ç”Ÿæˆå€™é€‰å¯è§†åŒ–æ–¹æ¡ˆ
4. è¯„ä¼°å’Œæ’åºæ¨èæ–¹æ¡ˆ
5. ç”Ÿæˆè¯¦ç»†çš„å›¾è¡¨é…ç½®
6. æä¾›æ¨èç†ç”±å’Œæ•°æ®æ´å¯Ÿ

## è¾“å‡ºæ ¼å¼ï¼š
è¯·ä»¥JSONæ ¼å¼è¿”å›æ¨èç»“æœï¼ŒåŒ…å«ï¼š
- primary_recommendation: ä¸»æ¨èæ–¹æ¡ˆ
- alternative_recommendations: å¤‡é€‰æ–¹æ¡ˆ
- data_insights: æ•°æ®æ´å¯Ÿ
- recommendation_reasoning: æ¨èç†ç”±

è¯·å§‹ç»ˆä¿æŒä¸“ä¸šã€å‡†ç¡®ã€ç”¨æˆ·å‹å¥½çš„æ¨èæ ‡å‡†ã€‚
"""
    
    agent = AssistantAgent(
        name="visualization_recommender",
        model_client=self.model_client,
        system_message=system_message,
        description="ä¸“ä¸šçš„å¯è§†åŒ–æ¨èæ™ºèƒ½ä½“ï¼Œæä¾›æ™ºèƒ½çš„æ•°æ®å¯è§†åŒ–æ–¹æ¡ˆ"
    )
    
    return agent
```

## ğŸ“Š æ¨èèƒ½åŠ›çŸ©é˜µ

### å›¾è¡¨ç±»å‹æ”¯æŒ

| å›¾è¡¨ç±»å‹ | æ•°æ®é€‚ç”¨æ€§ | æ¨èå‡†ç¡®åº¦ | é…ç½®å®Œæ•´åº¦ | ç”¨æˆ·ä½“éªŒ |
|---------|-----------|-----------|-----------|----------|
| æŸ±çŠ¶å›¾ | âœ… åˆ†ç±»+æ•°å€¼ | 95% | ä¼˜ç§€ | ä¼˜ç§€ |
| æŠ˜çº¿å›¾ | âœ… æ—¶é—´+æ•°å€¼ | 93% | ä¼˜ç§€ | ä¼˜ç§€ |
| é¥¼å›¾ | âœ… åˆ†ç±»å æ¯” | 90% | è‰¯å¥½ | è‰¯å¥½ |
| æ•£ç‚¹å›¾ | âœ… æ•°å€¼å…³ç³» | 88% | è‰¯å¥½ | ä¸­ç­‰ |
| è¡¨æ ¼ | âœ… é€šç”¨ | 85% | ä¼˜ç§€ | ä¸­ç­‰ |
| çƒ­åŠ›å›¾ | âœ… å¤šç»´æ•°æ® | 80% | ä¸­ç­‰ | ä¸­ç­‰ |
| é¢ç§¯å›¾ | âœ… æ—¶é—´ç´¯ç§¯ | 85% | è‰¯å¥½ | è‰¯å¥½ |

### æ•°æ®ç‰¹å¾è¯†åˆ«

| ç‰¹å¾ç±»å‹ | è¯†åˆ«å‡†ç¡®åº¦ | å¤„ç†èƒ½åŠ› | è¯´æ˜ |
|---------|-----------|----------|------|
| æ•°å€¼å‹æ•°æ® | 95% | ä¼˜ç§€ | æ”¯æŒæ•´æ•°ã€æµ®ç‚¹æ•°è¯†åˆ« |
| åˆ†ç±»å‹æ•°æ® | 92% | ä¼˜ç§€ | æ”¯æŒå­—ç¬¦ä¸²ã€æšä¸¾è¯†åˆ« |
| æ—¶é—´å‹æ•°æ® | 88% | è‰¯å¥½ | æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼ |
| æ•°æ®åˆ†å¸ƒ | 85% | è‰¯å¥½ | åˆ†ææ•°æ®åˆ†å¸ƒç‰¹å¾ |
| æ•°æ®å…³ç³» | 80% | ä¸­ç­‰ | è¯†åˆ«ç›¸å…³æ€§å’Œå±‚æ¬¡å…³ç³» |
| å¼‚å¸¸å€¼æ£€æµ‹ | 75% | ä¸­ç­‰ | åŸºç¡€å¼‚å¸¸å€¼è¯†åˆ« |

### æŸ¥è¯¢æ„å›¾ç†è§£

| æ„å›¾ç±»å‹ | ç†è§£å‡†ç¡®åº¦ | åŒ¹é…åº¦ | è¯´æ˜ |
|---------|-----------|--------|------|
| å¯¹æ¯”åˆ†æ | 90% | ä¼˜ç§€ | GROUP BY, ORDER BYè¯†åˆ« |
| è¶‹åŠ¿åˆ†æ | 88% | ä¼˜ç§€ | æ—¶é—´åºåˆ—æŸ¥è¯¢è¯†åˆ« |
| å æ¯”åˆ†æ | 85% | è‰¯å¥½ | èšåˆå‡½æ•°è¯†åˆ« |
| æ’ååˆ†æ | 87% | è‰¯å¥½ | ORDER BY + LIMITè¯†åˆ« |
| å…³ç³»åˆ†æ | 80% | ä¸­ç­‰ | JOINæŸ¥è¯¢è¯†åˆ« |
| æ¢ç´¢åˆ†æ | 75% | ä¸­ç­‰ | åŸºç¡€SELECTè¯†åˆ« |

## ğŸ” è´¨é‡ä¿è¯æœºåˆ¶

### 1. å¤šå±‚æ¬¡éªŒè¯
```python
class VisualizationQualityValidator:
    """
    å¯è§†åŒ–è´¨é‡éªŒè¯å™¨
    
    éªŒè¯ç»´åº¦:
    1. æ•°æ®é€‚é…æ€§éªŒè¯
    2. å›¾è¡¨é…ç½®å®Œæ•´æ€§éªŒè¯
    3. ç”¨æˆ·ä½“éªŒè´¨é‡éªŒè¯
    4. æ€§èƒ½å½±å“è¯„ä¼°
    """
    
    def __init__(self):
        self.data_validator = DataCompatibilityValidator()
        self.config_validator = ChartConfigValidator()
        self.ux_validator = UserExperienceValidator()
        self.performance_validator = PerformanceValidator()
    
    async def validate_recommendation(self, recommendation: Dict[str, Any], 
                                    data_characteristics: Dict[str, Any]) -> Dict[str, Any]:
        """
        éªŒè¯æ¨èæ–¹æ¡ˆè´¨é‡
        """
        validation_result = {
            'is_valid': True,
            'quality_score': 0.0,
            'issues': [],
            'suggestions': []
        }
        
        try:
            # 1. æ•°æ®é€‚é…æ€§éªŒè¯
            data_validation = await self.data_validator.validate(
                recommendation, data_characteristics
            )
            validation_result['data_compatibility'] = data_validation
            
            # 2. é…ç½®å®Œæ•´æ€§éªŒè¯
            config_validation = await self.config_validator.validate(recommendation)
            validation_result['config_completeness'] = config_validation
            
            # 3. ç”¨æˆ·ä½“éªŒéªŒè¯
            ux_validation = await self.ux_validator.validate(
                recommendation, data_characteristics
            )
            validation_result['user_experience'] = ux_validation
            
            # 4. æ€§èƒ½å½±å“è¯„ä¼°
            performance_validation = await self.performance_validator.validate(
                recommendation, data_characteristics
            )
            validation_result['performance_impact'] = performance_validation
            
            # è®¡ç®—ç»¼åˆè´¨é‡åˆ†æ•°
            validation_result['quality_score'] = self._calculate_quality_score([
                data_validation, config_validation, ux_validation, performance_validation
            ])
            
            return validation_result
            
        except Exception as e:
            logger.error(f"æ¨èéªŒè¯å¤±è´¥: {str(e)}")
            validation_result.update({
                'is_valid': False,
                'error': str(e)
            })
            return validation_result
```

### 2. è‡ªåŠ¨ä¼˜åŒ–å»ºè®®
```python
class AutoOptimizationEngine:
    """
    è‡ªåŠ¨ä¼˜åŒ–å¼•æ“
    
    ä¼˜åŒ–ç­–ç•¥:
    1. åŸºäºéªŒè¯ç»“æœçš„è‡ªåŠ¨ä¿®å¤
    2. æ€§èƒ½ä¼˜åŒ–å»ºè®®
    3. ç”¨æˆ·ä½“éªŒæ”¹è¿›å»ºè®®
    4. æ›¿ä»£æ–¹æ¡ˆç”Ÿæˆ
    """
    
    async def optimize_recommendation(self, recommendation: Dict[str, Any], 
                                    validation_result: Dict[str, Any]) -> Dict[str, Any]:
        """
        åŸºäºéªŒè¯ç»“æœä¼˜åŒ–æ¨èæ–¹æ¡ˆ
        """
        optimized_recommendation = recommendation.copy()
        
        try:
            issues = validation_result.get('issues', [])
            
            for issue in issues:
                issue_type = issue.get('type', '')
                severity = issue.get('severity', 'low')
                
                if severity in ['high', 'critical']:
                    # é«˜ä¼˜å…ˆçº§é—®é¢˜éœ€è¦ç«‹å³ä¿®å¤
                    optimized_recommendation = await self._fix_critical_issue(
                        optimized_recommendation, issue
                    )
                elif severity == 'medium':
                    # ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜æä¾›ä¼˜åŒ–å»ºè®®
                    optimized_recommendation = await self._apply_optimization(
                        optimized_recommendation, issue
                    )
            
            return optimized_recommendation
            
        except Exception as e:
            logger.error(f"è‡ªåŠ¨ä¼˜åŒ–å¤±è´¥: {str(e)}")
            return recommendation
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¨èç¼“å­˜æœºåˆ¶
```python
class RecommendationCache:
    """
    æ¨èç»“æœç¼“å­˜æœºåˆ¶
    
    ç¼“å­˜ç­–ç•¥:
    1. åŸºäºæ•°æ®ç‰¹å¾çš„ç¼“å­˜é”®
    2. æ™ºèƒ½ç¼“å­˜å¤±æ•ˆæœºåˆ¶
    3. åˆ†å±‚ç¼“å­˜æ¶æ„
    4. ç¼“å­˜é¢„çƒ­ç­–ç•¥
    """
    
    def __init__(self, cache_size: int = 1000, ttl: int = 3600):
        self.cache = {}
        self.cache_size = cache_size
        self.ttl = ttl
        self.access_times = {}
        self.creation_times = {}
    
    def generate_cache_key(self, data_characteristics: Dict[str, Any], 
                          query_intent: Dict[str, Any]) -> str:
        """
        ç”Ÿæˆç¼“å­˜é”®
        """
        try:
            # æå–å…³é”®ç‰¹å¾
            key_features = {
                'column_count': data_characteristics.get('column_count', 0),
                'row_count_range': self._get_row_count_range(
                    data_characteristics.get('row_count', 0)
                ),
                'has_numeric': data_characteristics.get('has_numeric', False),
                'has_categorical': data_characteristics.get('has_categorical', False),
                'has_temporal': data_characteristics.get('has_temporal', False),
                'query_type': query_intent.get('query_type', 'UNKNOWN'),
                'analysis_goal': query_intent.get('analysis_goal', 'EXPLORATION')
            }
            
            # ç”Ÿæˆå“ˆå¸Œé”®
            import hashlib
            key_str = json.dumps(key_features, sort_keys=True)
            cache_key = hashlib.md5(key_str.encode()).hexdigest()
            
            return cache_key
            
        except Exception as e:
            logger.error(f"ç¼“å­˜é”®ç”Ÿæˆå¤±è´¥: {str(e)}")
            return 'default_key'
```

### 2. å¹¶è¡Œæ¨èå¤„ç†
```python
class ParallelRecommendationProcessor:
    """
    å¹¶è¡Œæ¨èå¤„ç†å™¨
    
    å¹¶è¡Œç­–ç•¥:
    1. å€™é€‰æ–¹æ¡ˆå¹¶è¡Œç”Ÿæˆ
    2. é…ç½®ç”Ÿæˆå¹¶è¡Œå¤„ç†
    3. éªŒè¯è¿‡ç¨‹å¹¶è¡Œæ‰§è¡Œ
    4. ç»“æœèšåˆä¼˜åŒ–
    """
    
    def __init__(self, max_workers: int = 4):
        self.max_workers = max_workers
        self.executor = ThreadPoolExecutor(max_workers=max_workers)
    
    async def process_recommendations_parallel(self, 
                                             candidates: List[Dict[str, Any]], 
                                             query_result: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        å¹¶è¡Œå¤„ç†æ¨èæ–¹æ¡ˆ
        """
        try:
            # åˆ›å»ºå¹¶è¡Œä»»åŠ¡
            tasks = []
            for candidate in candidates:
                task = asyncio.create_task(
                    self._process_single_recommendation(candidate, query_result)
                )
                tasks.append(task)
            
            # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            results = await asyncio.gather(*tasks, return_exceptions=True)
            
            # è¿‡æ»¤æˆåŠŸçš„ç»“æœ
            successful_results = []
            for result in results:
                if not isinstance(result, Exception):
                    successful_results.append(result)
                else:
                    logger.error(f"å¹¶è¡Œå¤„ç†å¤±è´¥: {str(result)}")
            
            return successful_results
            
        except Exception as e:
            logger.error(f"å¹¶è¡Œæ¨èå¤„ç†å¤±è´¥: {str(e)}")
            return []
```

## ğŸ¯ ç³»ç»Ÿé›†æˆè¦ç‚¹

### 1. æ™ºèƒ½ä½“æ³¨å†Œ
```python
# åœ¨ Text2SQLGraphFlow ä¸­æ³¨å†Œå¯è§†åŒ–æ¨èæ™ºèƒ½ä½“
self.visualization_recommender = self._create_visualization_recommender_agent()

# æ³¨å†Œåˆ°æ™ºèƒ½ä½“å›¢é˜Ÿ
self.team.add_participant(self.visualization_recommender)
```

### 2. æµå¼å“åº”å¤„ç†
```python
class VisualizationStreamHandler:
    """
    å¯è§†åŒ–æ¨èæµå¼å“åº”å¤„ç†å™¨
    """
    
    async def handle_visualization_stream(self, recommendation_result: Dict[str, Any]) -> None:
        """
        å¤„ç†å¯è§†åŒ–æ¨èçš„æµå¼å“åº”
        """
        try:
            # å‘é€æ¨èå¼€å§‹ä¿¡å·
            await self._send_stream_event({
                'type': 'visualization_start',
                'agent': 'visualization_recommender',
                'message': 'æ­£åœ¨åˆ†ææ•°æ®ç‰¹å¾ï¼Œç”Ÿæˆå¯è§†åŒ–æ¨è...'
            })
            
            # å‘é€æ•°æ®æ´å¯Ÿ
            if 'data_insights' in recommendation_result:
                await self._send_stream_event({
                    'type': 'data_insights',
                    'agent': 'visualization_recommender',
                    'insights': recommendation_result['data_insights']
                })
            
            # å‘é€ä¸»æ¨è
            if 'primary_recommendation' in recommendation_result:
                await self._send_stream_event({
                    'type': 'primary_recommendation',
                    'agent': 'visualization_recommender',
                    'recommendation': recommendation_result['primary_recommendation']
                })
            
        except Exception as e:
            logger.error(f"å¯è§†åŒ–æµå¼å“åº”å¤„ç†å¤±è´¥: {str(e)}")
```

## ğŸ“ˆ æœªæ¥æ‰©å±•æ–¹å‘

### 1. é«˜çº§å¯è§†åŒ–ç±»å‹
- **3Då¯è§†åŒ–**: æ”¯æŒä¸‰ç»´æ•£ç‚¹å›¾ã€æ›²é¢å›¾
- **åœ°ç†å¯è§†åŒ–**: æ”¯æŒåœ°å›¾ã€çƒ­åŠ›åœ°å›¾
- **ç½‘ç»œå›¾**: æ”¯æŒå…³ç³»ç½‘ç»œã€æ ‘çŠ¶å›¾
- **åŠ¨æ€å›¾è¡¨**: æ”¯æŒæ—¶é—´è½´åŠ¨ç”»ã€å®æ—¶æ›´æ–°

### 2. æ™ºèƒ½åŒ–å¢å¼º
- **æœºå™¨å­¦ä¹ æ¨è**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„ä¸ªæ€§åŒ–æ¨è
- **è‡ªç„¶è¯­è¨€ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨æè¿°å’Œæ´å¯Ÿ
- **å¼‚å¸¸æ£€æµ‹**: æ™ºèƒ½è¯†åˆ«æ•°æ®å¼‚å¸¸å¹¶åœ¨å¯è§†åŒ–ä¸­æ ‡æ³¨
- **è¶‹åŠ¿é¢„æµ‹**: åŸºäºå†å²æ•°æ®é¢„æµ‹æœªæ¥è¶‹åŠ¿

### 3. äº¤äº’ä½“éªŒå‡çº§
- **æ‹–æ‹½é…ç½®**: æ”¯æŒæ‹–æ‹½æ–¹å¼é…ç½®å›¾è¡¨
- **å®æ—¶é¢„è§ˆ**: é…ç½®ä¿®æ”¹æ—¶å®æ—¶é¢„è§ˆæ•ˆæœ
- **åä½œåŠŸèƒ½**: æ”¯æŒå¤šç”¨æˆ·åä½œç¼–è¾‘å›¾è¡¨
- **å¯¼å‡ºåˆ†äº«**: æ”¯æŒå¤šæ ¼å¼å¯¼å‡ºå’Œåˆ†äº«åŠŸèƒ½

---

é€šè¿‡ä»¥ä¸Šè¯¦ç»†çš„è¿˜åŸæç¤ºè¯ï¼Œå¯ä»¥å®Œæ•´é‡å»ºText2SQLç³»ç»Ÿä¸­çš„å¯è§†åŒ–æ¨èæ™ºèƒ½ä½“ï¼Œå®ç°æ™ºèƒ½ã€å‡†ç¡®ã€ç”¨æˆ·å‹å¥½çš„æ•°æ®å¯è§†åŒ–æ¨èæœåŠ¡ã€‚