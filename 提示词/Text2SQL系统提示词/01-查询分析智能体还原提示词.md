# æŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“è¿˜åŸæç¤ºè¯

## ğŸ¯ æ™ºèƒ½ä½“æ¦‚è¿°

æŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“ï¼ˆQuery Analyzer Agentï¼‰æ˜¯Text2SQLç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£æ·±åº¦ç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œè¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œæå–ç›¸å…³å®ä½“ï¼Œå¹¶ä¸ºåç»­çš„SQLç”Ÿæˆæä¾›ç»“æ„åŒ–çš„åˆ†æç»“æœã€‚

## ğŸ§  æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªç„¶è¯­è¨€æ„å›¾ç†è§£
- **æŸ¥è¯¢ç±»å‹è¯†åˆ«**: åŒºåˆ†æŸ¥è¯¢ã€ç»Ÿè®¡ã€æ’åºã€ç­›é€‰ç­‰ä¸åŒæ“ä½œç±»å‹
- **ä¸šåŠ¡åœºæ™¯ç†è§£**: ç†è§£ç”¨æˆ·åœ¨ç‰¹å®šä¸šåŠ¡åœºæ™¯ä¸‹çš„æŸ¥è¯¢éœ€æ±‚
- **å¤æ‚åº¦è¯„ä¼°**: è¯„ä¼°æŸ¥è¯¢çš„å¤æ‚ç¨‹åº¦å’Œæ‰€éœ€çš„å¤„ç†æ­¥éª¤
- **æ­§ä¹‰æ¶ˆè§£**: å¤„ç†è‡ªç„¶è¯­è¨€ä¸­çš„æ­§ä¹‰è¡¨è¾¾

### 2. æ•°æ®å®ä½“è¯†åˆ«
- **ä¸šåŠ¡å®ä½“æå–**: è¯†åˆ«æŸ¥è¯¢ä¸­æ¶‰åŠçš„ä¸šåŠ¡å¯¹è±¡ï¼ˆå®¢æˆ·ã€è®¢å•ã€äº§å“ç­‰ï¼‰
- **å±æ€§å­—æ®µæ˜ å°„**: å°†è‡ªç„¶è¯­è¨€æè¿°æ˜ å°„åˆ°å…·ä½“çš„æ•°æ®åº“å­—æ®µ
- **æ•°å€¼æ¡ä»¶è¯†åˆ«**: è¯†åˆ«æŸ¥è¯¢ä¸­çš„æ•°å€¼èŒƒå›´ã€æ¯”è¾ƒæ¡ä»¶ç­‰
- **æ—¶é—´æ¡ä»¶è§£æ**: è§£ææ—¶é—´ç›¸å…³çš„æŸ¥è¯¢æ¡ä»¶

### 3. è¡¨å…³ç³»åˆ†æ
- **ä¸»è¡¨ç¡®å®š**: ç¡®å®šæŸ¥è¯¢çš„ä¸»è¦æ•°æ®è¡¨
- **å…³è”è¡¨è¯†åˆ«**: è¯†åˆ«éœ€è¦å…³è”çš„å…¶ä»–è¡¨
- **è¿æ¥æ¡ä»¶åˆ†æ**: åˆ†æè¡¨ä¹‹é—´çš„è¿æ¥å…³ç³»å’Œæ¡ä»¶
- **æ•°æ®è·¯å¾„è§„åˆ’**: è§„åˆ’ä»æŸ¥è¯¢æ„å›¾åˆ°æ•°æ®è·å–çš„è·¯å¾„

## ğŸ”§ æŠ€æœ¯å®ç°

### æ™ºèƒ½ä½“å®šä¹‰

```python
class QueryAnalyzerAgent:
    """
    æŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“å®ç°
    
    åŠŸèƒ½:
    1. æ¥æ”¶ç”¨æˆ·è‡ªç„¶è¯­è¨€æŸ¥è¯¢
    2. åˆ†ææŸ¥è¯¢æ„å›¾å’Œå®ä½“
    3. æ˜ å°„åˆ°æ•°æ®åº“ç»“æ„
    4. è¾“å‡ºç»“æ„åŒ–åˆ†æç»“æœ
    """
    
    def __init__(self, db_schema: str, model_client):
        self.db_schema = db_schema
        self.model_client = model_client
        self.system_message = self._build_system_message()
    
    def _build_system_message(self) -> str:
        """æ„å»ºç³»ç»Ÿæç¤ºè¯"""
        return f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åº“æŸ¥è¯¢åˆ†æä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ·±åº¦åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œç†è§£å…¶æ„å›¾å¹¶è¯†åˆ«ç›¸å…³çš„æ•°æ®åº“å®ä½“ã€‚

## æ ¸å¿ƒèŒè´£ï¼š
1. **æ„å›¾è¯†åˆ«**: å‡†ç¡®ç†è§£ç”¨æˆ·æƒ³è¦æ‰§è¡Œçš„æ“ä½œç±»å‹
2. **å®ä½“æå–**: è¯†åˆ«æŸ¥è¯¢ä¸­æ¶‰åŠçš„æ‰€æœ‰ä¸šåŠ¡å®ä½“
3. **å­—æ®µæ˜ å°„**: å°†ä¸šåŠ¡æ¦‚å¿µæ˜ å°„åˆ°å…·ä½“çš„æ•°æ®åº“å­—æ®µ
4. **å…³ç³»åˆ†æ**: åˆ†ææ¶‰åŠçš„è¡¨ä¹‹é—´çš„å…³è”å…³ç³»
5. **æ¡ä»¶è§£æ**: è§£ææŸ¥è¯¢ä¸­çš„ç­›é€‰å’Œæ’åºæ¡ä»¶

## åˆ†ææ¡†æ¶ï¼š

### 1. æŸ¥è¯¢æ„å›¾åˆ†ç±»
- **æ•°æ®æŸ¥è¯¢**: è·å–ç‰¹å®šæ•°æ®è®°å½•
- **ç»Ÿè®¡åˆ†æ**: è®¡ç®—æ€»æ•°ã€å¹³å‡å€¼ã€æœ€å¤§å€¼ç­‰
- **æ’åºå±•ç¤º**: æŒ‰æŸç§è§„åˆ™æ’åºæ˜¾ç¤ºæ•°æ®
- **æ¡ä»¶ç­›é€‰**: æ ¹æ®æ¡ä»¶è¿‡æ»¤æ•°æ®
- **å…³è”æŸ¥è¯¢**: è·¨è¡¨å…³è”è·å–æ•°æ®
- **æ—¶é—´åˆ†æ**: åŸºäºæ—¶é—´ç»´åº¦çš„æ•°æ®åˆ†æ

### 2. å®ä½“è¯†åˆ«æ¨¡å¼
- **ä¸»ä½“å®ä½“**: æŸ¥è¯¢çš„æ ¸å¿ƒå¯¹è±¡ï¼ˆå¦‚å®¢æˆ·ã€è®¢å•ã€äº§å“ï¼‰
- **å±æ€§å®ä½“**: å®ä½“çš„å…·ä½“å±æ€§ï¼ˆå¦‚å§“åã€ä»·æ ¼ã€æ—¥æœŸï¼‰
- **å…³ç³»å®ä½“**: å®ä½“é—´çš„å…³è”å…³ç³»ï¼ˆå¦‚å®¢æˆ·çš„è®¢å•ã€è®¢å•çš„å•†å“ï¼‰
- **æ¡ä»¶å®ä½“**: ç­›é€‰å’Œé™åˆ¶æ¡ä»¶ï¼ˆå¦‚æ—¶é—´èŒƒå›´ã€æ•°å€¼åŒºé—´ï¼‰

### 3. æ•°æ®åº“æ˜ å°„è§„åˆ™
- **è¡¨åæ˜ å°„**: ä¸šåŠ¡å®ä½“åˆ°æ•°æ®åº“è¡¨çš„æ˜ å°„
- **å­—æ®µæ˜ å°„**: å±æ€§æè¿°åˆ°å…·ä½“å­—æ®µçš„æ˜ å°„
- **å…³ç³»æ˜ å°„**: ä¸šåŠ¡å…³ç³»åˆ°å¤–é”®å…³è”çš„æ˜ å°„
- **æ¡ä»¶æ˜ å°„**: è‡ªç„¶è¯­è¨€æ¡ä»¶åˆ°SQLæ¡ä»¶çš„æ˜ å°„

## æ•°æ®åº“ç»“æ„ä¿¡æ¯ï¼š
{self.db_schema}

## åˆ†æè¾“å‡ºæ ¼å¼ï¼š
è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„åŒ–æ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š

```json
{{
  "query_intent": {{
    "type": "æŸ¥è¯¢ç±»å‹ï¼ˆquery/statistics/sort/filter/join/time_analysisï¼‰",
    "description": "æŸ¥è¯¢æ„å›¾çš„è¯¦ç»†æè¿°",
    "complexity": "å¤æ‚åº¦è¯„çº§ï¼ˆsimple/medium/complexï¼‰"
  }},
  "entities": {{
    "primary_entity": "ä¸»è¦æŸ¥è¯¢å®ä½“",
    "secondary_entities": ["æ¬¡è¦ç›¸å…³å®ä½“åˆ—è¡¨"],
    "attributes": ["æ¶‰åŠçš„å±æ€§å­—æ®µåˆ—è¡¨"],
    "conditions": ["ç­›é€‰æ¡ä»¶åˆ—è¡¨"]
  }},
  "table_mapping": {{
    "primary_table": "ä¸»è¦æ•°æ®è¡¨",
    "related_tables": ["ç›¸å…³è¡¨åˆ—è¡¨"],
    "join_conditions": ["è¡¨è¿æ¥æ¡ä»¶"],
    "required_fields": ["éœ€è¦çš„å­—æ®µåˆ—è¡¨"]
  }},
  "query_structure": {{
    "select_fields": ["éœ€è¦é€‰æ‹©çš„å­—æ®µ"],
    "where_conditions": ["WHEREæ¡ä»¶"],
    "join_requirements": ["JOINéœ€æ±‚"],
    "group_by_fields": ["åˆ†ç»„å­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰"],
    "order_by_fields": ["æ’åºå­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰"],
    "limit_requirements": "é™åˆ¶æ¡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰"
  }},
  "analysis_confidence": "åˆ†æç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰",
  "potential_issues": ["å¯èƒ½çš„é—®é¢˜æˆ–æ­§ä¹‰"]
}}
```

## åˆ†æç¤ºä¾‹ï¼š

**ç”¨æˆ·æŸ¥è¯¢**: "æŸ¥æ‰¾è´­ä¹°é‡‘é¢æœ€é«˜çš„å‰10ä¸ªå®¢æˆ·"

**åˆ†æç»“æœ**:
```json
{{
  "query_intent": {{
    "type": "statistics",
    "description": "ç»Ÿè®¡å®¢æˆ·è´­ä¹°é‡‘é¢å¹¶æŒ‰é‡‘é¢é™åºæ’åˆ—ï¼Œè·å–å‰10å",
    "complexity": "medium"
  }},
  "entities": {{
    "primary_entity": "å®¢æˆ·",
    "secondary_entities": ["è®¢å•", "è´­ä¹°é‡‘é¢"],
    "attributes": ["å®¢æˆ·ä¿¡æ¯", "è´­ä¹°æ€»é‡‘é¢"],
    "conditions": ["æŒ‰é‡‘é¢æ’åº", "é™åˆ¶å‰10å"]
  }},
  "table_mapping": {{
    "primary_table": "Customer",
    "related_tables": ["Invoice"],
    "join_conditions": ["Customer.CustomerId = Invoice.CustomerId"],
    "required_fields": ["Customer.FirstName", "Customer.LastName", "Invoice.Total"]
  }},
  "query_structure": {{
    "select_fields": ["Customer.FirstName", "Customer.LastName", "SUM(Invoice.Total) as TotalAmount"],
    "where_conditions": [],
    "join_requirements": ["INNER JOIN Invoice ON Customer.CustomerId = Invoice.CustomerId"],
    "group_by_fields": ["Customer.CustomerId", "Customer.FirstName", "Customer.LastName"],
    "order_by_fields": ["TotalAmount DESC"],
    "limit_requirements": "LIMIT 10"
  }},
  "analysis_confidence": 0.95,
  "potential_issues": []
}}
```

## ç‰¹æ®Šå¤„ç†è§„åˆ™ï¼š

### 1. æ—¶é—´è¡¨è¾¾å¤„ç†
- "æœ€è¿‘ä¸€ä¸ªæœˆ" â†’ å½“å‰æ—¥æœŸå‰30å¤©
- "ä»Šå¹´" â†’ å½“å‰å¹´ä»½
- "ä¸Šå­£åº¦" â†’ ä¸Šä¸€ä¸ªå­£åº¦çš„æ—¶é—´èŒƒå›´
- "å»å¹´åŒæœŸ" â†’ å»å¹´ç›¸åŒæ—¶é—´æ®µ

### 2. æ•°å€¼è¡¨è¾¾å¤„ç†
- "æœ€é«˜çš„" â†’ ORDER BY DESC LIMIT
- "è¶…è¿‡100" â†’ WHERE field > 100
- "å‰10å" â†’ ORDER BY DESC LIMIT 10
- "å¹³å‡" â†’ AVG()å‡½æ•°

### 3. æ¨¡ç³Šè¡¨è¾¾å¤„ç†
- "ç›¸å…³çš„" â†’ é€šè¿‡å¤–é”®å…³è”
- "ç±»ä¼¼çš„" â†’ LIKEæ¨¡ç³ŠåŒ¹é…
- "å¤§çº¦" â†’ èŒƒå›´æŸ¥è¯¢
- "ç»å¸¸" â†’ é¢‘æ¬¡ç»Ÿè®¡

### 4. ä¸šåŠ¡æœ¯è¯­æ˜ å°„
- "å®¢æˆ·" â†’ Customerè¡¨
- "è®¢å•" â†’ Invoiceè¡¨
- "å•†å“" â†’ Trackè¡¨
- "é”€å”®é¢" â†’ Invoice.Total
- "è´­ä¹°è®°å½•" â†’ InvoiceLineè¡¨

è¯·ä»”ç»†åˆ†æç”¨æˆ·æŸ¥è¯¢ï¼Œæä¾›å‡†ç¡®ã€è¯¦ç»†çš„ç»“æ„åŒ–åˆ†æç»“æœã€‚
"""
    
    async def analyze_query(self, user_query: str) -> Dict[str, Any]:
        """åˆ†æç”¨æˆ·æŸ¥è¯¢"""
        try:
            # æ„å»ºåˆ†ææç¤º
            analysis_prompt = f"""
è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·æŸ¥è¯¢ï¼š

ç”¨æˆ·æŸ¥è¯¢: "{user_query}"

è¯·æŒ‰ç…§ç³»ç»Ÿæ¶ˆæ¯ä¸­å®šä¹‰çš„æ ¼å¼ï¼Œæä¾›è¯¦ç»†çš„ç»“æ„åŒ–åˆ†æç»“æœã€‚
"""
            
            # è°ƒç”¨AIæ¨¡å‹è¿›è¡Œåˆ†æ
            response = await self.model_client.create(
                messages=[
                    {"role": "system", "content": self.system_message},
                    {"role": "user", "content": analysis_prompt}
                ],
                temperature=0.1,  # ä½æ¸©åº¦ç¡®ä¿åˆ†æçš„ä¸€è‡´æ€§
                max_tokens=2000
            )
            
            # è§£æå“åº”
            analysis_result = self._parse_analysis_response(response.choices[0].message.content)
            
            return analysis_result
            
        except Exception as e:
            logger.error(f"æŸ¥è¯¢åˆ†æå¤±è´¥: {str(e)}")
            return self._create_error_response(str(e))
    
    def _parse_analysis_response(self, response_content: str) -> Dict[str, Any]:
        """è§£æAIå“åº”å†…å®¹"""
        try:
            # æå–JSONéƒ¨åˆ†
            json_start = response_content.find('{')
            json_end = response_content.rfind('}') + 1
            
            if json_start != -1 and json_end != -1:
                json_content = response_content[json_start:json_end]
                analysis_result = json.loads(json_content)
                return analysis_result
            else:
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼ï¼Œè¿”å›æ–‡æœ¬åˆ†æ
                return {
                    "analysis_text": response_content,
                    "structured_analysis": False
                }
                
        except json.JSONDecodeError as e:
            logger.warning(f"JSONè§£æå¤±è´¥: {str(e)}")
            return {
                "analysis_text": response_content,
                "structured_analysis": False,
                "parse_error": str(e)
            }
    
    def _create_error_response(self, error_message: str) -> Dict[str, Any]:
        """åˆ›å»ºé”™è¯¯å“åº”"""
        return {
            "error": True,
            "message": f"æŸ¥è¯¢åˆ†æå¤±è´¥: {error_message}",
            "query_intent": {
                "type": "unknown",
                "description": "æ— æ³•åˆ†ææŸ¥è¯¢æ„å›¾",
                "complexity": "unknown"
            }
        }
```

### æ™ºèƒ½ä½“æ³¨å†Œå’Œé…ç½®

```python
def _create_query_analyzer_agent(self) -> AssistantAgent:
    """
    åˆ›å»ºæŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“
    
    é…ç½®è¦ç‚¹:
    1. è®¾ç½®ä¸“ä¸šçš„ç³»ç»Ÿæç¤ºè¯
    2. é…ç½®åˆé€‚çš„æ¨¡å‹å‚æ•°
    3. è®¾ç½®è¾“å‡ºæ ¼å¼è¦æ±‚
    4. é…ç½®é”™è¯¯å¤„ç†æœºåˆ¶
    """
    
    # æ„å»ºè¯¦ç»†çš„ç³»ç»Ÿæç¤ºè¯
    system_message = f"""
ä½ æ˜¯Text2SQLç³»ç»Ÿä¸­çš„æŸ¥è¯¢åˆ†æä¸“å®¶ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ·±åº¦ç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¹¶æä¾›ç»“æ„åŒ–çš„åˆ†æç»“æœã€‚

## ä½ çš„ä¸“ä¸šèƒ½åŠ›ï¼š
1. **è¯­è¨€ç†è§£**: å‡†ç¡®ç†è§£å„ç§è‡ªç„¶è¯­è¨€è¡¨è¾¾æ–¹å¼
2. **æ„å›¾è¯†åˆ«**: è¯†åˆ«ç”¨æˆ·çš„çœŸå®æŸ¥è¯¢æ„å›¾
3. **å®ä½“æŠ½å–**: æå–æŸ¥è¯¢ä¸­çš„å…³é”®ä¸šåŠ¡å®ä½“
4. **ç»“æ„æ˜ å°„**: å°†è‡ªç„¶è¯­è¨€æ˜ å°„åˆ°æ•°æ®åº“ç»“æ„
5. **é€»è¾‘åˆ†æ**: åˆ†ææŸ¥è¯¢çš„é€»è¾‘å…³ç³»å’Œæ‰§è¡Œæ­¥éª¤

## å·¥ä½œæµç¨‹ï¼š
1. **æ¥æ”¶æŸ¥è¯¢**: è·å–ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢
2. **æ„å›¾åˆ†æ**: ç†è§£ç”¨æˆ·æƒ³è¦å®ç°çš„ç›®æ ‡
3. **å®ä½“è¯†åˆ«**: è¯†åˆ«æŸ¥è¯¢æ¶‰åŠçš„æ•°æ®å®ä½“
4. **ç»“æ„æ˜ å°„**: æ˜ å°„åˆ°å…·ä½“çš„æ•°æ®åº“è¡¨å’Œå­—æ®µ
5. **è¾“å‡ºåˆ†æ**: æä¾›ç»“æ„åŒ–çš„åˆ†æç»“æœ

## æ•°æ®åº“ç»“æ„ï¼š
{self.db_schema}

## è¾“å‡ºè¦æ±‚ï¼š
- æä¾›æ¸…æ™°çš„åˆ†ææ€è·¯
- è¾“å‡ºç»“æ„åŒ–çš„åˆ†æç»“æœ
- æ ‡è¯†å¯èƒ½çš„æ­§ä¹‰å’Œé—®é¢˜
- ä¸ºåç»­SQLç”Ÿæˆæä¾›å……åˆ†ä¿¡æ¯

è¯·å§‹ç»ˆä¿æŒä¸“ä¸šã€å‡†ç¡®ã€è¯¦ç»†çš„åˆ†æé£æ ¼ã€‚
"""
    
    # åˆ›å»ºæ™ºèƒ½ä½“å®ä¾‹
    agent = AssistantAgent(
        name="query_analyzer",
        model_client=self.model_client,
        system_message=system_message,
        description="ä¸“ä¸šçš„æŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“ï¼Œè´Ÿè´£ç†è§£è‡ªç„¶è¯­è¨€æŸ¥è¯¢å¹¶æä¾›ç»“æ„åŒ–åˆ†æ"
    )
    
    return agent
```

## ğŸ“Š åˆ†æèƒ½åŠ›çŸ©é˜µ

### æ”¯æŒçš„æŸ¥è¯¢ç±»å‹

| æŸ¥è¯¢ç±»å‹ | æè¿° | ç¤ºä¾‹ | å¤æ‚åº¦ |
|---------|------|------|--------|
| ç®€å•æŸ¥è¯¢ | å•è¡¨æ•°æ®è·å– | "æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·" | Simple |
| æ¡ä»¶æŸ¥è¯¢ | å¸¦ç­›é€‰æ¡ä»¶çš„æŸ¥è¯¢ | "æ˜¾ç¤ºæ¥è‡ªç¾å›½çš„å®¢æˆ·" | Simple |
| æ’åºæŸ¥è¯¢ | å¸¦æ’åºçš„æ•°æ®æŸ¥è¯¢ | "æŒ‰å§“åæ’åºæ˜¾ç¤ºå®¢æˆ·" | Simple |
| èšåˆæŸ¥è¯¢ | ç»Ÿè®¡åˆ†æç±»æŸ¥è¯¢ | "ç»Ÿè®¡æ¯ä¸ªå›½å®¶çš„å®¢æˆ·æ•°é‡" | Medium |
| å…³è”æŸ¥è¯¢ | å¤šè¡¨è¿æ¥æŸ¥è¯¢ | "æ˜¾ç¤ºå®¢æˆ·åŠå…¶è®¢å•ä¿¡æ¯" | Medium |
| å¤æ‚ç»Ÿè®¡ | å¤æ‚çš„ç»Ÿè®¡åˆ†æ | "åˆ†ææ¯æœˆé”€å”®è¶‹åŠ¿" | Complex |
| åµŒå¥—æŸ¥è¯¢ | åŒ…å«å­æŸ¥è¯¢çš„å¤æ‚æŸ¥è¯¢ | "æ‰¾å‡ºè´­ä¹°æœ€å¤šçš„å®¢æˆ·" | Complex |

### å®ä½“è¯†åˆ«èƒ½åŠ›

| å®ä½“ç±»å‹ | è¯†åˆ«èƒ½åŠ› | æ˜ å°„å‡†ç¡®åº¦ | ç¤ºä¾‹ |
|---------|----------|------------|------|
| å®¢æˆ·å®ä½“ | âœ… é«˜ | 95% | Customerè¡¨ç›¸å…³ |
| è®¢å•å®ä½“ | âœ… é«˜ | 95% | Invoiceè¡¨ç›¸å…³ |
| äº§å“å®ä½“ | âœ… é«˜ | 90% | Track/Albumè¡¨ç›¸å…³ |
| æ—¶é—´å®ä½“ | âœ… ä¸­ | 85% | æ—¥æœŸæ—¶é—´å­—æ®µ |
| æ•°å€¼å®ä½“ | âœ… ä¸­ | 80% | ä»·æ ¼ã€æ•°é‡ç­‰ |
| å…³ç³»å®ä½“ | âœ… ä¸­ | 75% | è¡¨é—´å…³è”å…³ç³» |

### æ¡ä»¶è§£æèƒ½åŠ›

| æ¡ä»¶ç±»å‹ | æ”¯æŒç¨‹åº¦ | å‡†ç¡®ç‡ | ç¤ºä¾‹ |
|---------|----------|--------|------|
| ç­‰å€¼æ¡ä»¶ | âœ… å®Œå…¨æ”¯æŒ | 95% | "å›½å®¶æ˜¯ç¾å›½" |
| èŒƒå›´æ¡ä»¶ | âœ… å®Œå…¨æ”¯æŒ | 90% | "ä»·æ ¼åœ¨100-500ä¹‹é—´" |
| æ¨¡ç³Šæ¡ä»¶ | âœ… éƒ¨åˆ†æ”¯æŒ | 80% | "å§“ååŒ…å«Smith" |
| æ—¶é—´æ¡ä»¶ | âœ… éƒ¨åˆ†æ”¯æŒ | 75% | "æœ€è¿‘ä¸€ä¸ªæœˆ" |
| å¤åˆæ¡ä»¶ | âš ï¸ æœ‰é™æ”¯æŒ | 70% | "ç¾å›½å®¢æˆ·ä¸”è´­ä¹°è¶…è¿‡1000" |
| å¦å®šæ¡ä»¶ | âš ï¸ æœ‰é™æ”¯æŒ | 65% | "ä¸æ˜¯æ¥è‡ªç¾å›½çš„å®¢æˆ·" |

## ğŸ” è´¨é‡ä¿è¯æœºåˆ¶

### 1. åˆ†æéªŒè¯
```python
def validate_analysis_result(self, analysis: Dict[str, Any]) -> bool:
    """
    éªŒè¯åˆ†æç»“æœçš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
    
    éªŒè¯é¡¹ç›®:
    1. å¿…è¦å­—æ®µå®Œæ•´æ€§
    2. è¡¨åå’Œå­—æ®µåæœ‰æ•ˆæ€§
    3. æŸ¥è¯¢é€»è¾‘åˆç†æ€§
    4. æ•°æ®ç±»å‹åŒ¹é…æ€§
    """
    required_fields = [
        'query_intent', 'entities', 'table_mapping', 'query_structure'
    ]
    
    # æ£€æŸ¥å¿…è¦å­—æ®µ
    for field in required_fields:
        if field not in analysis:
            return False
    
    # éªŒè¯è¡¨åæœ‰æ•ˆæ€§
    primary_table = analysis.get('table_mapping', {}).get('primary_table')
    if primary_table and not self._is_valid_table(primary_table):
        return False
    
    # éªŒè¯å­—æ®µåæœ‰æ•ˆæ€§
    required_fields = analysis.get('query_structure', {}).get('required_fields', [])
    for field in required_fields:
        if not self._is_valid_field(field):
            return False
    
    return True

def _is_valid_table(self, table_name: str) -> bool:
    """éªŒè¯è¡¨åæ˜¯å¦å­˜åœ¨äºæ•°æ®åº“ç»“æ„ä¸­"""
    valid_tables = ['Customer', 'Invoice', 'InvoiceLine', 'Track', 'Album', 'Artist', 'Genre', 'MediaType', 'Playlist', 'PlaylistTrack', 'Employee']
    return table_name in valid_tables

def _is_valid_field(self, field_name: str) -> bool:
    """éªŒè¯å­—æ®µåæ˜¯å¦æœ‰æ•ˆ"""
    # ç®€åŒ–éªŒè¯ï¼Œå®é™…åº”è¯¥æ£€æŸ¥å…·ä½“è¡¨çš„å­—æ®µ
    return '.' in field_name or field_name.upper() in ['COUNT', 'SUM', 'AVG', 'MAX', 'MIN']
```

### 2. ç½®ä¿¡åº¦è¯„ä¼°
```python
def calculate_confidence(self, analysis: Dict[str, Any], user_query: str) -> float:
    """
    è®¡ç®—åˆ†æç»“æœçš„ç½®ä¿¡åº¦
    
    è¯„ä¼°å› ç´ :
    1. æŸ¥è¯¢æ˜ç¡®æ€§ (40%)
    2. å®ä½“è¯†åˆ«å‡†ç¡®æ€§ (30%)
    3. è¡¨æ˜ å°„æ­£ç¡®æ€§ (20%)
    4. é€»è¾‘ä¸€è‡´æ€§ (10%)
    """
    confidence_score = 0.0
    
    # æŸ¥è¯¢æ˜ç¡®æ€§è¯„ä¼°
    query_clarity = self._assess_query_clarity(user_query)
    confidence_score += query_clarity * 0.4
    
    # å®ä½“è¯†åˆ«å‡†ç¡®æ€§
    entity_accuracy = self._assess_entity_accuracy(analysis)
    confidence_score += entity_accuracy * 0.3
    
    # è¡¨æ˜ å°„æ­£ç¡®æ€§
    mapping_correctness = self._assess_mapping_correctness(analysis)
    confidence_score += mapping_correctness * 0.2
    
    # é€»è¾‘ä¸€è‡´æ€§
    logic_consistency = self._assess_logic_consistency(analysis)
    confidence_score += logic_consistency * 0.1
    
    return min(confidence_score, 1.0)
```

### 3. é”™è¯¯å¤„ç†å’Œæ¢å¤
```python
def handle_analysis_error(self, error: Exception, user_query: str) -> Dict[str, Any]:
    """
    å¤„ç†åˆ†æè¿‡ç¨‹ä¸­çš„é”™è¯¯
    
    é”™è¯¯ç±»å‹:
    1. æ¨¡å‹è°ƒç”¨å¤±è´¥
    2. å“åº”è§£æé”™è¯¯
    3. ç»“æ„éªŒè¯å¤±è´¥
    4. è¶…æ—¶é”™è¯¯
    """
    error_type = type(error).__name__
    
    if error_type == 'TimeoutError':
        return self._create_timeout_fallback(user_query)
    elif error_type == 'JSONDecodeError':
        return self._create_parsing_fallback(user_query)
    elif error_type == 'ValidationError':
        return self._create_validation_fallback(user_query)
    else:
        return self._create_generic_fallback(user_query, str(error))

def _create_timeout_fallback(self, user_query: str) -> Dict[str, Any]:
    """åˆ›å»ºè¶…æ—¶æƒ…å†µä¸‹çš„å¤‡ç”¨åˆ†æ"""
    return {
        "query_intent": {
            "type": "query",
            "description": f"åŸºäºæŸ¥è¯¢å†…å®¹çš„åŸºç¡€åˆ†æ: {user_query}",
            "complexity": "unknown"
        },
        "entities": {
            "primary_entity": "æœªç¡®å®š",
            "secondary_entities": [],
            "attributes": [],
            "conditions": []
        },
        "table_mapping": {
            "primary_table": "Customer",  # é»˜è®¤ä¸»è¡¨
            "related_tables": [],
            "join_conditions": [],
            "required_fields": ["*"]
        },
        "analysis_confidence": 0.3,
        "fallback_reason": "åˆ†æè¶…æ—¶ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
    }
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶
```python
class QueryAnalysisCache:
    """
    æŸ¥è¯¢åˆ†æç»“æœç¼“å­˜
    
    ä¼˜åŒ–ç­–ç•¥:
    1. ç›¸ä¼¼æŸ¥è¯¢ç¼“å­˜
    2. å®ä½“æ˜ å°„ç¼“å­˜
    3. æ¨¡å¼è¯†åˆ«ç¼“å­˜
    """
    
    def __init__(self, max_size: int = 1000):
        self.cache = {}
        self.max_size = max_size
        self.access_count = {}
    
    def get_cached_analysis(self, query: str) -> Optional[Dict[str, Any]]:
        """è·å–ç¼“å­˜çš„åˆ†æç»“æœ"""
        query_hash = self._hash_query(query)
        
        if query_hash in self.cache:
            self.access_count[query_hash] = self.access_count.get(query_hash, 0) + 1
            return self.cache[query_hash]
        
        # æ£€æŸ¥ç›¸ä¼¼æŸ¥è¯¢
        similar_query = self._find_similar_query(query)
        if similar_query:
            return self.cache[similar_query]
        
        return None
    
    def cache_analysis(self, query: str, analysis: Dict[str, Any]):
        """ç¼“å­˜åˆ†æç»“æœ"""
        if len(self.cache) >= self.max_size:
            self._evict_least_used()
        
        query_hash = self._hash_query(query)
        self.cache[query_hash] = analysis
        self.access_count[query_hash] = 1
```

### 2. å¹¶è¡Œå¤„ç†
```python
async def parallel_analysis(self, user_query: str) -> Dict[str, Any]:
    """
    å¹¶è¡Œæ‰§è¡Œå¤šä¸ªåˆ†æä»»åŠ¡
    
    å¹¶è¡Œä»»åŠ¡:
    1. æ„å›¾è¯†åˆ«
    2. å®ä½“æå–
    3. è¡¨æ˜ å°„
    4. æ¡ä»¶è§£æ
    """
    tasks = [
        self._analyze_intent(user_query),
        self._extract_entities(user_query),
        self._map_tables(user_query),
        self._parse_conditions(user_query)
    ]
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    # åˆå¹¶ç»“æœ
    final_analysis = self._merge_analysis_results(results)
    
    return final_analysis
```

---

**æ€»ç»“**: æŸ¥è¯¢åˆ†ææ™ºèƒ½ä½“æ˜¯Text2SQLç³»ç»Ÿçš„æ ¸å¿ƒå…¥å£ï¼Œè´Ÿè´£å°†è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬æ¢ä¸ºç»“æ„åŒ–çš„åˆ†æç»“æœã€‚é€šè¿‡æ·±åº¦çš„æ„å›¾ç†è§£ã€ç²¾ç¡®çš„å®ä½“è¯†åˆ«å’Œæ™ºèƒ½çš„è¡¨æ˜ å°„ï¼Œä¸ºåç»­çš„SQLç”Ÿæˆæä¾›é«˜è´¨é‡çš„è¾“å…¥ã€‚è¯¥æ™ºèƒ½ä½“å…·å¤‡å¼ºå¤§çš„é”™è¯¯å¤„ç†èƒ½åŠ›ã€æ€§èƒ½ä¼˜åŒ–æœºåˆ¶å’Œè´¨é‡ä¿è¯ä½“ç³»ï¼Œç¡®ä¿åˆ†æç»“æœçš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚