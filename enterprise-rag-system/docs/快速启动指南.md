# 企业级RAG知识库系统快速启动指南

## 🚀 项目现状

**✅ 已完成**: 完整的后端核心服务 (75%功能)
**❌ 待完成**: API接口层 + 前端界面 (25%功能)

**您可以立即基于现有的强大后端服务开始开发！**

---

## 📦 已实现的核心功能

### 🤖 智能体系统 (完整可用)
```python
# 使用增强版AutoGen服务
from app.services.enhanced_autogen_service import enhanced_autogen_service

# 初始化服务
await enhanced_autogen_service.initialize()

# 处理用户查询
response = await enhanced_autogen_service.process_query(
    query="什么是人工智能？",
    search_modes=["semantic", "graph", "hybrid"],
    top_k=10
)

print(f"答案: {response.content}")
print(f"置信度: {response.confidence}")
print(f"处理时间: {response.processing_time}s")
```

### 📄 文档处理 (完整可用)
```python
# 使用增强版Marker服务
from app.services.enhanced_marker_service import enhanced_marker_service

# 解析文档并跟踪进度
processor_id = await enhanced_marker_service.parse_document_with_progress(
    file_path="/path/to/document.pdf",
    file_name="document.pdf",
    extract_images=True,
    extract_tables=True
)

# 获取处理状态
status = enhanced_marker_service.get_processing_status(processor_id)
print(f"处理进度: {status['progress']*100:.1f}%")

# 获取处理结果
result = enhanced_marker_service.get_processing_result(processor_id)
```

### 🔍 混合检索 (完整可用)
```python
# 使用增强版向量数据库服务
from app.services.enhanced_vector_db import enhanced_vector_db_service

# 初始化服务
await enhanced_vector_db_service.initialize()

# 执行混合检索
query_vector = await embedding_service.embed_query("人工智能的应用")
hybrid_result = await enhanced_vector_db_service.hybrid_search(
    collection_name="knowledge_base",
    query_vector=query_vector,
    query_text="人工智能的应用",
    top_k=10,
    vector_weight=0.7,
    keyword_weight=0.3
)

print(f"找到 {hybrid_result.total_results} 个相关结果")
```

### 🕸️ 知识图谱 (完整可用)
```python
# 使用增强版图谱服务
from app.services.enhanced_graph_service import enhanced_graph_service

# 初始化服务
await enhanced_graph_service.initialize()

# 构建知识图谱
graph_result = await enhanced_graph_service.build_knowledge_graph(
    document_id=1,
    content="人工智能是计算机科学的一个分支...",
    knowledge_base_id=1
)

print(f"创建了 {graph_result['entities_created']} 个实体")
print(f"创建了 {graph_result['relationships_created']} 个关系")
```

---

## 🛠️ 立即可开始的开发任务

### 1. 创建FastAPI应用入口 (30分钟)

**文件**: `backend/main.py`

```python
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager

from app.core.config import settings
from app.services.enhanced_autogen_service import enhanced_autogen_service
from app.services.enhanced_vector_db import enhanced_vector_db_service
from app.services.enhanced_graph_service import enhanced_graph_service

@asynccontextmanager
async def lifespan(app: FastAPI):
    # 启动时初始化服务
    await enhanced_autogen_service.initialize()
    await enhanced_vector_db_service.initialize()
    await enhanced_graph_service.initialize()
    yield
    # 关闭时清理资源

app = FastAPI(
    title=settings.PROJECT_NAME,
    description="企业级Agent+RAG知识库系统",
    version="1.0.0",
    lifespan=lifespan
)

# CORS中间件
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 健康检查
@app.get("/health")
async def health_check():
    return {"status": "healthy", "message": "服务运行正常"}

# 智能问答接口
@app.post("/api/v1/chat")
async def chat(query: str, search_modes: list = None):
    try:
        response = await enhanced_autogen_service.process_query(
            query=query,
            search_modes=search_modes or ["semantic"],
            top_k=10
        )
        return {
            "answer": response.content,
            "confidence": response.confidence,
            "processing_time": response.processing_time,
            "search_results": [
                {
                    "content": r.content,
                    "source": r.source,
                    "score": r.score
                }
                for r in response.search_results[:5]
            ]
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 2. 创建基础API路由 (2小时)

**文件**: `backend/app/api/chat.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Optional

from app.services.enhanced_autogen_service import enhanced_autogen_service

router = APIRouter(prefix="/api/v1/chat", tags=["聊天"])

class ChatRequest(BaseModel):
    query: str
    search_modes: Optional[List[str]] = ["semantic"]
    top_k: Optional[int] = 10
    knowledge_base_ids: Optional[List[int]] = None

class ChatResponse(BaseModel):
    answer: str
    confidence: float
    processing_time: float
    search_results: List[dict]
    quality_metrics: dict

@router.post("/", response_model=ChatResponse)
async def chat(request: ChatRequest):
    """智能问答接口"""
    try:
        response = await enhanced_autogen_service.process_query(
            query=request.query,
            search_modes=request.search_modes,
            top_k=request.top_k,
            knowledge_base_ids=request.knowledge_base_ids
        )
        
        return ChatResponse(
            answer=response.content,
            confidence=response.confidence,
            processing_time=response.processing_time,
            search_results=[
                {
                    "content": r.content,
                    "source": r.source,
                    "score": r.score,
                    "search_type": r.search_type
                }
                for r in response.search_results
            ],
            quality_metrics=response.quality_metrics
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"查询处理失败: {str(e)}")

@router.get("/health")
async def chat_health():
    """聊天服务健康检查"""
    health = await enhanced_autogen_service.health_check()
    return health
```

### 3. 创建文档管理API (2小时)

**文件**: `backend/app/api/document.py`

```python
from fastapi import APIRouter, UploadFile, File, HTTPException
from typing import List

from app.services.enhanced_marker_service import enhanced_marker_service

router = APIRouter(prefix="/api/v1/documents", tags=["文档管理"])

@router.post("/upload")
async def upload_document(file: UploadFile = File(...)):
    """上传并处理文档"""
    try:
        # 保存文件
        file_path = f"/tmp/{file.filename}"
        with open(file_path, "wb") as f:
            content = await file.read()
            f.write(content)
        
        # 开始处理
        processor_id = await enhanced_marker_service.parse_document_with_progress(
            file_path=file_path,
            file_name=file.filename,
            extract_images=True,
            extract_tables=True
        )
        
        return {
            "processor_id": processor_id,
            "message": "文档上传成功，开始处理",
            "filename": file.filename
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"文档上传失败: {str(e)}")

@router.get("/status/{processor_id}")
async def get_processing_status(processor_id: str):
    """获取文档处理状态"""
    status = enhanced_marker_service.get_processing_status(processor_id)
    if not status:
        raise HTTPException(status_code=404, detail="处理器ID不存在")
    return status

@router.get("/result/{processor_id}")
async def get_processing_result(processor_id: str):
    """获取文档处理结果"""
    result = enhanced_marker_service.get_processing_result(processor_id)
    if not result:
        raise HTTPException(status_code=404, detail="处理结果不存在或未完成")
    return result
```

### 4. 创建简单的前端聊天界面 (4小时)

**文件**: `frontend/user-app/src/pages/chat.tsx`

```tsx
import React, { useState } from 'react';
import { Button, Input, Card, Spin, Typography } from 'antd';
import { SendOutlined } from '@ant-design/icons';

const { TextArea } = Input;
const { Title, Text } = Typography;

interface ChatMessage {
  id: string;
  type: 'user' | 'assistant';
  content: string;
  confidence?: number;
  processing_time?: number;
}

export default function ChatPage() {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);

  const sendMessage = async () => {
    if (!input.trim()) return;

    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      type: 'user',
      content: input
    };

    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setLoading(true);

    try {
      const response = await fetch('/api/v1/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: input,
          search_modes: ['semantic', 'graph'],
          top_k: 10
        }),
      });

      const data = await response.json();

      const assistantMessage: ChatMessage = {
        id: (Date.now() + 1).toString(),
        type: 'assistant',
        content: data.answer,
        confidence: data.confidence,
        processing_time: data.processing_time
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('发送消息失败:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: 800, margin: '0 auto', padding: 20 }}>
      <Title level={2}>智能问答助手</Title>
      
      <div style={{ height: 500, overflowY: 'auto', marginBottom: 20 }}>
        {messages.map(message => (
          <Card
            key={message.id}
            style={{
              marginBottom: 10,
              backgroundColor: message.type === 'user' ? '#e6f7ff' : '#f6ffed'
            }}
          >
            <Text strong>{message.type === 'user' ? '用户' : 'AI助手'}</Text>
            <div style={{ marginTop: 8 }}>{message.content}</div>
            {message.confidence && (
              <div style={{ marginTop: 8, fontSize: 12, color: '#666' }}>
                置信度: {(message.confidence * 100).toFixed(1)}% | 
                处理时间: {message.processing_time?.toFixed(2)}s
              </div>
            )}
          </Card>
        ))}
        {loading && (
          <Card>
            <Spin /> AI正在思考中...
          </Card>
        )}
      </div>

      <div style={{ display: 'flex', gap: 10 }}>
        <TextArea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="请输入您的问题..."
          autoSize={{ minRows: 2, maxRows: 4 }}
          onPressEnter={(e) => {
            if (!e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          }}
        />
        <Button
          type="primary"
          icon={<SendOutlined />}
          onClick={sendMessage}
          loading={loading}
          disabled={!input.trim()}
        >
          发送
        </Button>
      </div>
    </div>
  );
}
```

---

## 🎯 开发优先级建议

### 第一优先级 (立即开始)
1. **创建FastAPI应用入口** - 30分钟
2. **实现基础聊天API** - 2小时
3. **创建简单聊天界面** - 4小时

### 第二优先级 (本周完成)
1. **文档管理API** - 1天
2. **知识库管理API** - 1天
3. **管理后台界面** - 2天

### 第三优先级 (下周完成)
1. **图谱可视化** - 2天
2. **系统监控面板** - 1天
3. **用户界面优化** - 2天

---

## 🔧 环境配置

### 后端启动
```bash
cd backend
pip install -r requirements.txt
python main.py
```

### 前端启动
```bash
# 用户界面
cd frontend/user-app
npm install
npm run dev

# 管理后台
cd frontend/admin-app
npm install
npm run dev
```

**您现在就可以基于这些强大的后端服务开始开发了！所有核心功能都已就绪，只需要添加API接口和前端界面即可。**
