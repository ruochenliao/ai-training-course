# ä¼ä¸šçº§RAGçŸ¥è¯†åº“ç³»ç»Ÿå¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸš€ é¡¹ç›®ç°çŠ¶

**âœ… å·²å®Œæˆ**: å®Œæ•´çš„åç«¯æ ¸å¿ƒæœåŠ¡ (75%åŠŸèƒ½)
**âŒ å¾…å®Œæˆ**: APIæ¥å£å±‚ + å‰ç«¯ç•Œé¢ (25%åŠŸèƒ½)

**æ‚¨å¯ä»¥ç«‹å³åŸºäºç°æœ‰çš„å¼ºå¤§åç«¯æœåŠ¡å¼€å§‹å¼€å‘ï¼**

---

## ğŸ“¦ å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### ğŸ¤– æ™ºèƒ½ä½“ç³»ç»Ÿ (å®Œæ•´å¯ç”¨)
```python
# ä½¿ç”¨å¢å¼ºç‰ˆAutoGenæœåŠ¡
from app.services.enhanced_autogen_service import enhanced_autogen_service

# åˆå§‹åŒ–æœåŠ¡
await enhanced_autogen_service.initialize()

# å¤„ç†ç”¨æˆ·æŸ¥è¯¢
response = await enhanced_autogen_service.process_query(
    query="ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    search_modes=["semantic", "graph", "hybrid"],
    top_k=10
)

print(f"ç­”æ¡ˆ: {response.content}")
print(f"ç½®ä¿¡åº¦: {response.confidence}")
print(f"å¤„ç†æ—¶é—´: {response.processing_time}s")
```

### ğŸ“„ æ–‡æ¡£å¤„ç† (å®Œæ•´å¯ç”¨)
```python
# ä½¿ç”¨å¢å¼ºç‰ˆMarkeræœåŠ¡
from app.services.enhanced_marker_service import enhanced_marker_service

# è§£ææ–‡æ¡£å¹¶è·Ÿè¸ªè¿›åº¦
processor_id = await enhanced_marker_service.parse_document_with_progress(
    file_path="/path/to/document.pdf",
    file_name="document.pdf",
    extract_images=True,
    extract_tables=True
)

# è·å–å¤„ç†çŠ¶æ€
status = enhanced_marker_service.get_processing_status(processor_id)
print(f"å¤„ç†è¿›åº¦: {status['progress']*100:.1f}%")

# è·å–å¤„ç†ç»“æœ
result = enhanced_marker_service.get_processing_result(processor_id)
```

### ğŸ” æ··åˆæ£€ç´¢ (å®Œæ•´å¯ç”¨)
```python
# ä½¿ç”¨å¢å¼ºç‰ˆå‘é‡æ•°æ®åº“æœåŠ¡
from app.services.enhanced_vector_db import enhanced_vector_db_service

# åˆå§‹åŒ–æœåŠ¡
await enhanced_vector_db_service.initialize()

# æ‰§è¡Œæ··åˆæ£€ç´¢
query_vector = await embedding_service.embed_query("äººå·¥æ™ºèƒ½çš„åº”ç”¨")
hybrid_result = await enhanced_vector_db_service.hybrid_search(
    collection_name="knowledge_base",
    query_vector=query_vector,
    query_text="äººå·¥æ™ºèƒ½çš„åº”ç”¨",
    top_k=10,
    vector_weight=0.7,
    keyword_weight=0.3
)

print(f"æ‰¾åˆ° {hybrid_result.total_results} ä¸ªç›¸å…³ç»“æœ")
```

### ğŸ•¸ï¸ çŸ¥è¯†å›¾è°± (å®Œæ•´å¯ç”¨)
```python
# ä½¿ç”¨å¢å¼ºç‰ˆå›¾è°±æœåŠ¡
from app.services.enhanced_graph_service import enhanced_graph_service

# åˆå§‹åŒ–æœåŠ¡
await enhanced_graph_service.initialize()

# æ„å»ºçŸ¥è¯†å›¾è°±
graph_result = await enhanced_graph_service.build_knowledge_graph(
    document_id=1,
    content="äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯...",
    knowledge_base_id=1
)

print(f"åˆ›å»ºäº† {graph_result['entities_created']} ä¸ªå®ä½“")
print(f"åˆ›å»ºäº† {graph_result['relationships_created']} ä¸ªå…³ç³»")
```

---

## ğŸ› ï¸ ç«‹å³å¯å¼€å§‹çš„å¼€å‘ä»»åŠ¡

### 1. åˆ›å»ºFastAPIåº”ç”¨å…¥å£ (30åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/main.py`

```python
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager

from app.core.config import settings
from app.services.enhanced_autogen_service import enhanced_autogen_service
from app.services.enhanced_vector_db import enhanced_vector_db_service
from app.services.enhanced_graph_service import enhanced_graph_service

@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨æ—¶åˆå§‹åŒ–æœåŠ¡
    await enhanced_autogen_service.initialize()
    await enhanced_vector_db_service.initialize()
    await enhanced_graph_service.initialize()
    yield
    # å…³é—­æ—¶æ¸…ç†èµ„æº

app = FastAPI(
    title=settings.PROJECT_NAME,
    description="ä¼ä¸šçº§Agent+RAGçŸ¥è¯†åº“ç³»ç»Ÿ",
    version="1.0.0",
    lifespan=lifespan
)

# CORSä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# å¥åº·æ£€æŸ¥
@app.get("/health")
async def health_check():
    return {"status": "healthy", "message": "æœåŠ¡è¿è¡Œæ­£å¸¸"}

# æ™ºèƒ½é—®ç­”æ¥å£
@app.post("/api/v1/chat")
async def chat(query: str, search_modes: list = None):
    try:
        response = await enhanced_autogen_service.process_query(
            query=query,
            search_modes=search_modes or ["semantic"],
            top_k=10
        )
        return {
            "answer": response.content,
            "confidence": response.confidence,
            "processing_time": response.processing_time,
            "search_results": [
                {
                    "content": r.content,
                    "source": r.source,
                    "score": r.score
                }
                for r in response.search_results[:5]
            ]
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 2. åˆ›å»ºåŸºç¡€APIè·¯ç”± (2å°æ—¶)

**æ–‡ä»¶**: `backend/app/api/chat.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Optional

from app.services.enhanced_autogen_service import enhanced_autogen_service

router = APIRouter(prefix="/api/v1/chat", tags=["èŠå¤©"])

class ChatRequest(BaseModel):
    query: str
    search_modes: Optional[List[str]] = ["semantic"]
    top_k: Optional[int] = 10
    knowledge_base_ids: Optional[List[int]] = None

class ChatResponse(BaseModel):
    answer: str
    confidence: float
    processing_time: float
    search_results: List[dict]
    quality_metrics: dict

@router.post("/", response_model=ChatResponse)
async def chat(request: ChatRequest):
    """æ™ºèƒ½é—®ç­”æ¥å£"""
    try:
        response = await enhanced_autogen_service.process_query(
            query=request.query,
            search_modes=request.search_modes,
            top_k=request.top_k,
            knowledge_base_ids=request.knowledge_base_ids
        )
        
        return ChatResponse(
            answer=response.content,
            confidence=response.confidence,
            processing_time=response.processing_time,
            search_results=[
                {
                    "content": r.content,
                    "source": r.source,
                    "score": r.score,
                    "search_type": r.search_type
                }
                for r in response.search_results
            ],
            quality_metrics=response.quality_metrics
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æŸ¥è¯¢å¤„ç†å¤±è´¥: {str(e)}")

@router.get("/health")
async def chat_health():
    """èŠå¤©æœåŠ¡å¥åº·æ£€æŸ¥"""
    health = await enhanced_autogen_service.health_check()
    return health
```

### 3. åˆ›å»ºæ–‡æ¡£ç®¡ç†API (2å°æ—¶)

**æ–‡ä»¶**: `backend/app/api/document.py`

```python
from fastapi import APIRouter, UploadFile, File, HTTPException
from typing import List

from app.services.enhanced_marker_service import enhanced_marker_service

router = APIRouter(prefix="/api/v1/documents", tags=["æ–‡æ¡£ç®¡ç†"])

@router.post("/upload")
async def upload_document(file: UploadFile = File(...)):
    """ä¸Šä¼ å¹¶å¤„ç†æ–‡æ¡£"""
    try:
        # ä¿å­˜æ–‡ä»¶
        file_path = f"/tmp/{file.filename}"
        with open(file_path, "wb") as f:
            content = await file.read()
            f.write(content)
        
        # å¼€å§‹å¤„ç†
        processor_id = await enhanced_marker_service.parse_document_with_progress(
            file_path=file_path,
            file_name=file.filename,
            extract_images=True,
            extract_tables=True
        )
        
        return {
            "processor_id": processor_id,
            "message": "æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼Œå¼€å§‹å¤„ç†",
            "filename": file.filename
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æ–‡æ¡£ä¸Šä¼ å¤±è´¥: {str(e)}")

@router.get("/status/{processor_id}")
async def get_processing_status(processor_id: str):
    """è·å–æ–‡æ¡£å¤„ç†çŠ¶æ€"""
    status = enhanced_marker_service.get_processing_status(processor_id)
    if not status:
        raise HTTPException(status_code=404, detail="å¤„ç†å™¨IDä¸å­˜åœ¨")
    return status

@router.get("/result/{processor_id}")
async def get_processing_result(processor_id: str):
    """è·å–æ–‡æ¡£å¤„ç†ç»“æœ"""
    result = enhanced_marker_service.get_processing_result(processor_id)
    if not result:
        raise HTTPException(status_code=404, detail="å¤„ç†ç»“æœä¸å­˜åœ¨æˆ–æœªå®Œæˆ")
    return result
```

### 4. åˆ›å»ºç®€å•çš„å‰ç«¯èŠå¤©ç•Œé¢ (4å°æ—¶)

**æ–‡ä»¶**: `frontend/user-app/src/pages/chat.tsx`

```tsx
import React, { useState } from 'react';
import { Button, Input, Card, Spin, Typography } from 'antd';
import { SendOutlined } from '@ant-design/icons';

const { TextArea } = Input;
const { Title, Text } = Typography;

interface ChatMessage {
  id: string;
  type: 'user' | 'assistant';
  content: string;
  confidence?: number;
  processing_time?: number;
}

export default function ChatPage() {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);

  const sendMessage = async () => {
    if (!input.trim()) return;

    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      type: 'user',
      content: input
    };

    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setLoading(true);

    try {
      const response = await fetch('/api/v1/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: input,
          search_modes: ['semantic', 'graph'],
          top_k: 10
        }),
      });

      const data = await response.json();

      const assistantMessage: ChatMessage = {
        id: (Date.now() + 1).toString(),
        type: 'assistant',
        content: data.answer,
        confidence: data.confidence,
        processing_time: data.processing_time
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: 800, margin: '0 auto', padding: 20 }}>
      <Title level={2}>æ™ºèƒ½é—®ç­”åŠ©æ‰‹</Title>
      
      <div style={{ height: 500, overflowY: 'auto', marginBottom: 20 }}>
        {messages.map(message => (
          <Card
            key={message.id}
            style={{
              marginBottom: 10,
              backgroundColor: message.type === 'user' ? '#e6f7ff' : '#f6ffed'
            }}
          >
            <Text strong>{message.type === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹'}</Text>
            <div style={{ marginTop: 8 }}>{message.content}</div>
            {message.confidence && (
              <div style={{ marginTop: 8, fontSize: 12, color: '#666' }}>
                ç½®ä¿¡åº¦: {(message.confidence * 100).toFixed(1)}% | 
                å¤„ç†æ—¶é—´: {message.processing_time?.toFixed(2)}s
              </div>
            )}
          </Card>
        ))}
        {loading && (
          <Card>
            <Spin /> AIæ­£åœ¨æ€è€ƒä¸­...
          </Card>
        )}
      </div>

      <div style={{ display: 'flex', gap: 10 }}>
        <TextArea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
          autoSize={{ minRows: 2, maxRows: 4 }}
          onPressEnter={(e) => {
            if (!e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          }}
        />
        <Button
          type="primary"
          icon={<SendOutlined />}
          onClick={sendMessage}
          loading={loading}
          disabled={!input.trim()}
        >
          å‘é€
        </Button>
      </div>
    </div>
  );
}
```

---

## ğŸ¯ å¼€å‘ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€ä¼˜å…ˆçº§ (ç«‹å³å¼€å§‹)
1. **åˆ›å»ºFastAPIåº”ç”¨å…¥å£** - 30åˆ†é’Ÿ
2. **å®ç°åŸºç¡€èŠå¤©API** - 2å°æ—¶
3. **åˆ›å»ºç®€å•èŠå¤©ç•Œé¢** - 4å°æ—¶

### ç¬¬äºŒä¼˜å…ˆçº§ (æœ¬å‘¨å®Œæˆ)
1. **æ–‡æ¡£ç®¡ç†API** - 1å¤©
2. **çŸ¥è¯†åº“ç®¡ç†API** - 1å¤©
3. **ç®¡ç†åå°ç•Œé¢** - 2å¤©

### ç¬¬ä¸‰ä¼˜å…ˆçº§ (ä¸‹å‘¨å®Œæˆ)
1. **å›¾è°±å¯è§†åŒ–** - 2å¤©
2. **ç³»ç»Ÿç›‘æ§é¢æ¿** - 1å¤©
3. **ç”¨æˆ·ç•Œé¢ä¼˜åŒ–** - 2å¤©

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### åç«¯å¯åŠ¨
```bash
cd backend
pip install -r requirements.txt
python main.py
```

### å‰ç«¯å¯åŠ¨
```bash
# ç”¨æˆ·ç•Œé¢
cd frontend/user-app
npm install
npm run dev

# ç®¡ç†åå°
cd frontend/admin-app
npm install
npm run dev
```

**æ‚¨ç°åœ¨å°±å¯ä»¥åŸºäºè¿™äº›å¼ºå¤§çš„åç«¯æœåŠ¡å¼€å§‹å¼€å‘äº†ï¼æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²å°±ç»ªï¼Œåªéœ€è¦æ·»åŠ APIæ¥å£å’Œå‰ç«¯ç•Œé¢å³å¯ã€‚**
