# 企业RAG系统前后端接口联调指南

## 📋 概述

本文档详细说明了企业RAG系统前后端接口的联调方法、测试流程和常见问题解决方案。

## 🎯 接口架构概览

### 前端架构
- **框架**: Next.js 14 + TypeScript
- **UI库**: Ant Design 5.x
- **状态管理**: React Context + TanStack Query
- **HTTP客户端**: Axios

### 后端架构
- **框架**: FastAPI + Python 3.11
- **API版本**: v1 (`/api/v1/`)
- **认证方式**: JWT Bearer Token
- **文档地址**: http://localhost:8000/docs

## 🔗 完整接口清单

### 1. 认证授权接口 (`/api/v1/auth/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| POST | `/auth/login` | 表单登录 | `apiClient.login()` |
| POST | `/auth/login/json` | JSON登录 | `apiClient.loginJson()` |
| POST | `/auth/register` | 用户注册 | `apiClient.register()` |
| POST | `/auth/logout` | 用户登出 | `apiClient.logout()` |
| GET | `/auth/me` | 获取当前用户 | `apiClient.getCurrentUser()` |
| POST | `/auth/refresh` | 刷新令牌 | `apiClient.refreshToken()` |

### 2. 聊天对话接口 (`/api/v1/chat/`, `/api/v1/conversations/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| POST | `/chat/` | 发送消息 | `apiClient.sendChatMessage()` |
| POST | `/chat/stream` | 流式聊天 | `apiClient.streamChatMessage()` |
| GET | `/conversations/` | 获取对话列表 | `apiClient.getConversations()` |
| GET | `/conversations/{id}` | 获取对话详情 | `apiClient.getConversation()` |
| GET | `/conversations/{id}/messages` | 获取对话消息 | `apiClient.getMessages()` |
| DELETE | `/conversations/{id}` | 删除对话 | `apiClient.deleteConversation()` |

### 3. 知识库管理接口 (`/api/v1/knowledge-bases/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| GET | `/knowledge-bases/` | 获取知识库列表 | `apiClient.getKnowledgeBases()` |
| POST | `/knowledge-bases/` | 创建知识库 | `apiClient.createKnowledgeBase()` |
| GET | `/knowledge-bases/{id}` | 获取知识库详情 | `apiClient.getKnowledgeBase()` |
| PUT | `/knowledge-bases/{id}` | 更新知识库 | `apiClient.updateKnowledgeBase()` |
| DELETE | `/knowledge-bases/{id}` | 删除知识库 | `apiClient.deleteKnowledgeBase()` |

### 4. 文档管理接口 (`/api/v1/documents/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| GET | `/documents/` | 获取文档列表 | `apiClient.getDocuments()` |
| POST | `/documents/upload` | 上传文档 | `apiClient.uploadDocument()` |
| GET | `/documents/{id}` | 获取文档详情 | `apiClient.getDocument()` |
| DELETE | `/documents/{id}` | 删除文档 | `apiClient.deleteDocument()` |
| GET | `/documents/{id}/chunks` | 获取文档分块 | `apiClient.getDocumentChunks()` |
| POST | `/documents/batch-process` | 批量处理文档 | `apiClient.batchProcessDocuments()` |
| POST | `/documents/search` | 搜索文档 | `apiClient.searchDocuments()` |

### 5. 搜索检索接口 (`/api/v1/search/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| POST | `/search/vector` | 向量搜索 | `apiClient.vectorSearch()` |
| POST | `/search/graph` | 图谱搜索 | `apiClient.graphSearch()` |
| POST | `/search/hybrid` | 混合搜索 | `apiClient.hybridSearch()` |
| POST | `/advanced-search/` | 高级搜索 | `apiClient.advancedSearch()` |

### 6. 知识图谱接口 (`/api/v1/graph/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| GET | `/graph/visualize` | 图谱可视化 | `apiClient.getKnowledgeGraph()` |
| GET | `/graph/entities` | 获取实体列表 | `apiClient.getGraphEntities()` |
| GET | `/graph/relations` | 获取关系列表 | `apiClient.getGraphRelations()` |
| GET | `/graph/stats` | 图谱统计信息 | - |

### 7. 用户管理接口 (`/api/v1/users/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| GET | `/users/` | 获取用户列表 | `apiClient.getUsers()` |
| POST | `/users/` | 创建用户 | `apiClient.createUser()` |
| PUT | `/users/{id}` | 更新用户 | `apiClient.updateUser()` |
| DELETE | `/users/{id}` | 删除用户 | `apiClient.deleteUser()` |

### 8. 系统管理接口 (`/api/v1/admin/`, `/api/v1/system/`)

| 方法 | 端点 | 描述 | 前端方法 |
|------|------|------|----------|
| GET | `/health` | 系统健康检查 | `apiClient.getSystemHealth()` |
| GET | `/system/info` | 系统信息 | `apiClient.getSystemInfo()` |
| GET | `/admin/stats` | 系统统计 | `apiClient.getSystemStats()` |
| GET | `/admin/logs` | 系统日志 | `apiClient.getSystemLogs()` |

## 🚀 联调启动步骤

### 1. 启动后端服务

```bash
# 进入后端目录
cd enterprise-rag-system/backend

# 安装依赖
pip install -r requirements.txt

# 启动服务
python -m app.main
# 或者
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 启动前端服务

```bash
# 进入前端目录
cd enterprise-rag-system/frontend/unified-app

# 安装依赖
pnpm install

# 启动开发服务器
pnpm dev
```

### 3. 验证服务状态

- **后端API文档**: http://localhost:8000/docs
- **后端健康检查**: http://localhost:8000/health
- **前端应用**: http://localhost:3000

## 🧪 接口测试方法

### 方法1: 使用内置测试工具

访问前端管理后台的API测试页面：
```
http://localhost:3000/admin/api-test
```

### 方法2: 使用Python测试脚本

```bash
# 运行完整测试套件
python test_api_integration.py

# 指定测试参数
python test_api_integration.py \
  --base-url http://localhost:8000 \
  --username admin \
  --password admin123 \
  --output test_report.json
```

### 方法3: 使用浏览器开发者工具

1. 打开前端应用
2. 按F12打开开发者工具
3. 切换到Network标签
4. 执行前端操作，观察API请求

### 方法4: 使用Postman/Insomnia

导入API文档：
```
http://localhost:8000/openapi.json
```

## 🔧 常见问题与解决方案

### 1. CORS跨域问题

**问题**: 前端请求被CORS策略阻止

**解决方案**:
```python
# backend/app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # 前端地址
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. 认证Token问题

**问题**: 401 Unauthorized错误

**解决方案**:
1. 检查token是否正确设置
2. 验证token格式：`Bearer <token>`
3. 确认token未过期

```typescript
// 前端设置token
apiClient.setToken(loginResponse.access_token);
```

### 3. 接口路径不匹配

**问题**: 404 Not Found错误

**解决方案**:
1. 检查API路径是否正确
2. 确认后端路由是否注册
3. 验证HTTP方法是否匹配

### 4. 数据格式不匹配

**问题**: 422 Validation Error

**解决方案**:
1. 检查请求数据格式
2. 对比API文档中的schema
3. 验证必填字段

### 5. 网络连接问题

**问题**: Network Error或超时

**解决方案**:
1. 检查服务是否启动
2. 验证端口是否正确
3. 确认防火墙设置

## 📊 性能监控

### 响应时间监控

```typescript
// 前端监控
const startTime = Date.now();
const response = await apiClient.someMethod();
const responseTime = Date.now() - startTime;
console.log(`API响应时间: ${responseTime}ms`);
```

### 错误率统计

```typescript
// 错误统计
let totalRequests = 0;
let errorRequests = 0;

// 在axios拦截器中统计
apiClient.interceptors.response.use(
  response => {
    totalRequests++;
    return response;
  },
  error => {
    totalRequests++;
    errorRequests++;
    console.log(`错误率: ${(errorRequests/totalRequests*100).toFixed(2)}%`);
    return Promise.reject(error);
  }
);
```

## 🔄 持续集成

### 自动化测试

```yaml
# .github/workflows/api-test.yml
name: API Integration Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Start Backend
        run: |
          cd backend
          pip install -r requirements.txt
          python -m app.main &
      - name: Run API Tests
        run: python test_api_integration.py
```

### 接口文档同步

```bash
# 生成最新API文档
curl http://localhost:8000/openapi.json > docs/api-spec.json

# 更新前端类型定义
npx swagger-typescript-api -p docs/api-spec.json -o src/types/api.ts
```

## 📝 最佳实践

### 1. 错误处理

```typescript
// 统一错误处理
try {
  const result = await apiClient.someMethod();
  return result;
} catch (error) {
  if (error.response?.status === 401) {
    // 重新登录
    router.push('/login');
  } else {
    message.error(error.message || '操作失败');
  }
  throw error;
}
```

### 2. 请求重试

```typescript
// 自动重试机制
const retryRequest = async (fn: Function, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};
```

### 3. 缓存策略

```typescript
// 使用TanStack Query缓存
const { data, error, isLoading } = useQuery({
  queryKey: ['knowledge-bases'],
  queryFn: () => apiClient.getKnowledgeBases(),
  staleTime: 5 * 60 * 1000, // 5分钟
});
```

## 🎯 总结

通过本指南，您可以：

1. ✅ 了解完整的API接口清单
2. ✅ 掌握前后端联调方法
3. ✅ 使用多种测试工具验证接口
4. ✅ 解决常见的联调问题
5. ✅ 实施性能监控和持续集成

确保前后端接口的稳定性和一致性，为用户提供流畅的使用体验。
