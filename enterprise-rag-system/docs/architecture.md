# 企业级RAG知识库系统架构设计文档

## 1. 项目概述

本项目是一套基于大语言模型和多模态模型的Agent+RAG知识库系统，采用现代化的微服务架构，支持多种检索方式和智能问答功能。

### 1.1 核心特性
- 基于AutoGen的多智能体协作框架
- 支持语义检索、图谱检索、混合检索三种检索方式
- 集成通义千问3-8B嵌入模型和重排模型
- 基于Marker框架的高质量文档解析
- 类似Google Gemini的炫酷聊天界面
- 完整的知识库管理和可视化功能

## 2. 技术栈

### 2.1 后端技术栈
- **Web框架**: FastAPI 0.104.1
- **数据库**: 
  - MySQL (关系数据)
  - Milvus 2.3.4 (向量数据库)
  - Neo4j 5.14.0 (图数据库)
  - Redis 5.0.1 (缓存)
- **AI框架**: 
  - Microsoft AutoGen 0.2.18 (多智能体)
  - Marker 0.2.15 (文档解析)
- **模型服务**:
  - DeepSeek Chat (大语言模型)
  - Qwen VL Max Latest (多模态模型)
  - 通义千问3-8B (嵌入模型)
  - 通义千问3-Reranker-8B (重排模型)

### 2.2 前端技术栈
- **管理端**: Nuxt.js 3 + Vue 3 + Naive UI + TailwindCSS
- **用户端**: Next.js 14 + React 18 + Ant Design + TailwindCSS

## 3. 系统架构

### 3.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
├─────────────────────┬───────────────────────────────────────┤
│   管理后台           │            用户界面                    │
│ Nuxt.js + Vue3      │        Next.js + React               │
│ + Naive UI          │        + Ant Design                   │
└─────────────────────┴───────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      API网关层                               │
│              FastAPI Gateway                                │
│            认证/限流/路由                                     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                     业务服务层                               │
├─────────────┬─────────────┬─────────────┬─────────────┬─────┤
│ 知识库管理   │ 文档处理     │ 检索服务     │ 对话服务     │智能体│
│ 服务        │ 服务        │            │            │服务  │
└─────────────┴─────────────┴─────────────┴─────────────┴─────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      AI模型层                               │
├─────────────┬─────────────┬─────────────┬─────────────┬─────┤
│ DeepSeek    │ Qwen VL     │ 通义千问3-8B │ 通义千问3-   │     │
│ Chat        │ Max         │ 嵌入模型     │ Reranker-8B │     │
└─────────────┴─────────────┴─────────────┴─────────────┴─────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                     数据存储层                               │
├─────────────┬─────────────┬─────────────┬─────────────┬─────┤
│ MySQL       │ Milvus      │ Neo4j       │ Redis       │MinIO│
│ 关系数据     │ 向量数据库   │ 图数据库     │ 缓存        │文件 │
└─────────────┴─────────────┴─────────────┴─────────────┴─────┘
```

### 3.2 AutoGen多智能体架构
```
用户查询
    │
    ▼
┌─────────────────┐
│   协调智能体     │ ◄─── 负责任务分发和结果整合
│  Coordinator    │
└─────────────────┘
    │
    ├─────────────────────────────────────────┐
    ▼                 ▼                       ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────────┐
│ 语义检索     │ │ 图谱检索     │ │ 混合检索智能体   │
│ 智能体       │ │ 智能体       │ │                │
└─────────────┘ └─────────────┘ └─────────────────┘
    │                 │                       │
    ▼                 ▼                       ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────────┐
│ Milvus      │ │ Neo4j       │ │ Milvus + Neo4j  │
│ 向量检索     │ │ 图谱查询     │ │ + 重排模型       │
└─────────────┘ └─────────────┘ └─────────────────┘
    │                 │                       │
    └─────────────────┼───────────────────────┘
                      ▼
            ┌─────────────────┐
            │ 答案生成智能体   │
            │ + 质量评估      │
            └─────────────────┘
                      │
                      ▼
                  最终答案
```

## 4. 核心模块设计

### 4.1 文档处理模块
- **Marker集成**: 基于开源Marker框架进行文档解析
- **支持格式**: PDF, DOCX, PPTX, TXT, MD, HTML, CSV, XLSX, JSON
- **处理流程**: 
  1. 文件上传验证
  2. Marker解析提取结构化内容
  3. 智能分块处理
  4. 向量化存储到Milvus
  5. 实体抽取构建知识图谱

### 4.2 检索服务模块
- **语义检索**: 基于通义千问3-8B嵌入模型的向量相似度搜索
- **图谱检索**: 基于Neo4j的实体关系查询
- **混合检索**: 融合语义和图谱检索，使用重排模型优化结果
- **检索优化**: 支持多种相似度计算和结果重排

### 4.3 智能体服务模块
- **多智能体协作**: 基于AutoGen框架的智能体系统
- **专业化分工**: 不同智能体负责不同类型的检索任务
- **结果融合**: 智能融合多种检索方式的结果
- **质量控制**: 内置答案质量评估机制

## 5. 数据库设计

### 5.1 MySQL关系数据库
- **用户管理**: 用户信息、权限、会话
- **知识库管理**: 知识库元数据、文档信息
- **系统配置**: 模型配置、系统参数
- **操作日志**: 用户操作、系统事件记录

### 5.2 Milvus向量数据库
- **集合设计**: 按知识库分类的向量集合
- **索引策略**: IVF_FLAT索引，支持高效相似度搜索
- **元数据**: 文档ID、分块信息、来源等
- **分区策略**: 按时间或知识库进行分区

### 5.3 Neo4j图数据库
- **节点类型**: 实体、概念、文档
- **关系类型**: 包含、关联、引用、依赖
- **属性设计**: 实体属性、关系权重、时间戳
- **索引优化**: 实体名称、类型的全文索引

## 6. API设计

### 6.1 RESTful API规范
- **基础路径**: `/api/v1`
- **认证方式**: JWT Bearer Token
- **响应格式**: 统一JSON格式
- **错误处理**: 标准HTTP状态码 + 详细错误信息

### 6.2 主要API端点
```
POST /api/v1/documents/upload          # 文档上传
GET  /api/v1/documents                 # 文档列表
POST /api/v1/chat/query               # 智能问答
GET  /api/v1/knowledge-bases          # 知识库列表
POST /api/v1/search/semantic          # 语义检索
POST /api/v1/search/graph             # 图谱检索
POST /api/v1/search/hybrid            # 混合检索
GET  /api/v1/graph/visualize          # 图谱可视化
```

## 7. 部署架构

### 7.1 容器化部署
- **Docker**: 所有服务容器化
- **Docker Compose**: 本地开发环境
- **Kubernetes**: 生产环境编排

### 7.2 服务依赖
```
Frontend Apps
    │
    ▼
FastAPI Gateway
    │
    ├─── MySQL
    ├─── Redis
    ├─── Milvus
    ├─── Neo4j
    ├─── MinIO
    └─── AI Model Services
```

## 8. 安全设计

### 8.1 认证授权
- **JWT认证**: 无状态token认证
- **RBAC权限**: 基于角色的访问控制
- **API限流**: 防止恶意请求

### 8.2 数据安全
- **传输加密**: HTTPS/TLS
- **存储加密**: 敏感数据加密存储
- **访问控制**: 细粒度权限控制

## 9. 性能优化

### 9.1 缓存策略
- **Redis缓存**: 热点数据缓存
- **模型缓存**: 嵌入向量缓存
- **查询缓存**: 检索结果缓存

### 9.2 并发处理
- **异步处理**: FastAPI异步支持
- **任务队列**: Celery后台任务
- **连接池**: 数据库连接池优化

## 10. 监控运维

### 10.1 日志管理
- **结构化日志**: JSON格式日志
- **日志聚合**: 集中式日志收集
- **日志分析**: 错误监控和性能分析

### 10.2 健康检查
- **服务健康**: 各服务状态监控
- **模型健康**: AI模型可用性检查
- **数据库健康**: 数据库连接和性能监控

## 11. 扩展性设计

### 11.1 水平扩展
- **无状态设计**: 服务无状态，支持水平扩展
- **负载均衡**: 多实例负载分发
- **数据分片**: 大规模数据分片存储

### 11.2 模块化设计
- **插件架构**: 支持功能插件扩展
- **模型切换**: 支持不同AI模型切换
- **接口标准**: 统一的服务接口标准
